<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì GradQuest - PhD Life Simulator</title>
    <meta name="description"
        content="A text-based PhD life simulator game. Can you publish papers and graduate before running out of morale?">
    <meta name="author" content="XY-Vince">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-success: #22c55e;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1a2e 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .progress-bar {
            background: var(--bg-card);
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s;
        }

        .progress-fill.high {
            background: linear-gradient(90deg, #22c55e, #4ade80);
        }

        .progress-fill.medium {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .progress-fill.low {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .event-panel {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid var(--accent-primary);
            margin-bottom: 20px;
        }

        .event-panel h3 {
            color: var(--accent-primary);
            margin-bottom: 12px;
        }

        .message-log {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 16px;
            min-height: 80px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        @media (max-width: 800px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
        }

        .panel h3 {
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
        }

        .action-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            color: var(--text-primary);
        }

        .action-btn:hover {
            background: var(--accent-primary);
            transform: translateY(-2px);
        }

        .action-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn.disabled:hover {
            background: var(--bg-card);
            transform: none;
        }

        .action-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .action-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .action-btn:hover .action-desc {
            color: rgba(255, 255, 255, 0.8);
        }

        .badge-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .item-badge {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .status-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .status-badge.negative {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
        }

        .empty-text {
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.85rem;
        }

        .start-screen,
        .end-screen {
            text-align: center;
            padding: 60px 20px;
        }

        .start-btn {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 14px;
            padding: 16px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }

        .start-btn.secondary {
            background: var(--bg-card);
        }

        .end-screen.won {
            background: linear-gradient(180deg, rgba(34, 197, 94, 0.1) 0%, transparent 100%);
        }

        .end-screen.lost {
            background: linear-gradient(180deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 28px;
            max-width: 450px;
            width: 90%;
            text-align: center;
        }

        .modal h2 {
            margin-bottom: 12px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 0.95rem;
        }

        .modal-btn.primary {
            background: var(--accent-success);
            color: white;
        }

        .modal-btn.secondary {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .save-btn {
            width: 100%;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <h1>üéì GradQuest <span id="version-display"
                    style="font-size: 0.5em; color: var(--text-secondary); font-weight: normal;">V2.21</span></h1>
        </header>

        <div id="app">
            <!-- Start Screen -->
            <div id="start-screen" class="start-screen panel">
                <h2 style="margin-bottom: 16px;">Welcome to GradQuest!</h2>
                <p
                    style="color: var(--text-secondary); margin-bottom: 20px; max-width: 500px; margin: 0 auto 20px; font-size: 0.95rem;">
                    Survive the PhD journey: publish 3 papers, defend your thesis,<br>
                    and keep your morale above zero!
                </p>

                <!-- V2.20: Specialization Selection -->
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 1rem; margin-bottom: 12px;">Choose Your Research Field:</h3>
                    <div id="spec-selection"
                        style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <div class="spec-card" onclick="game.selectSpecialization('experimentalist')"
                            id="spec-experimentalist"
                            style="background: var(--card-bg); padding: 16px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; width: 160px; text-align: left; transition: all 0.2s;">
                            <div style="font-size: 1.3rem; margin-bottom: 8px;">üî¨ Experimentalist</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px;">Lab-based
                                research</div>
                            <div style="font-size: 0.7rem; color: var(--accent-green);">‚ú® Protocol Reuse</div>
                            <div style="font-size: 0.7rem; color: #fbbf24;">‚ö†Ô∏è Equipment-dependent</div>
                        </div>
                        <div class="spec-card" onclick="game.selectSpecialization('theoretician')"
                            id="spec-theoretician"
                            style="background: var(--card-bg); padding: 16px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; width: 160px; text-align: left; transition: all 0.2s;">
                            <div style="font-size: 1.3rem; margin-bottom: 8px;">üìê Theoretician</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px;">
                                Mathematical research</div>
                            <div style="font-size: 0.7rem; color: var(--accent-green);">‚ú® Conceptual Breakthrough</div>
                            <div style="font-size: 0.7rem; color: #fbbf24;">‚ö†Ô∏è Abstract results</div>
                        </div>
                        <div class="spec-card" onclick="game.selectSpecialization('computational')"
                            id="spec-computational"
                            style="background: var(--card-bg); padding: 16px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; width: 160px; text-align: left; transition: all 0.2s;">
                            <div style="font-size: 1.3rem; margin-bottom: 8px;">üíª Computational</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px;">
                                Data-driven research</div>
                            <div style="font-size: 0.7rem; color: var(--accent-green);">‚ú® Pipeline Automation</div>
                            <div style="font-size: 0.7rem; color: #fbbf24;">‚ö†Ô∏è Server-dependent</div>
                        </div>
                    </div>
                    <div id="spec-selected"
                        style="font-size: 0.85rem; color: var(--accent-blue); margin-top: 10px; min-height: 20px;">
                    </div>
                </div>

                <button class="start-btn" onclick="game.start()" id="start-game-btn" disabled style="opacity: 0.5;">üöÄ
                    Start PhD Journey</button>
                <button class="start-btn secondary" id="load-btn" onclick="game.load()" style="display: none;">üíæ Load
                    Game</button>
                <button class="start-btn secondary" onclick="game.showHelp()">Help</button>
            </div>

            <!-- Game Screen -->
            <div id="game-screen" style="display: none;">
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-label">üìÖ Date</div>
                        <div class="stat-value" id="date">Sep, Year 1</div>
                        <div style="color: var(--text-secondary); font-size: 0.7rem;"><span id="semester">Fall</span> ¬∑
                            Month <span id="total-months">1</span> ¬∑ <span id="credits-display">0</span> credits</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üí™ Morale</div>
                        <div class="stat-value" style="font-size: 1.2rem;" id="morale-status">üòä Good</div>
                        <div class="progress-bar">
                            <div class="progress-fill high" id="morale-bar" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üë®‚Äçüè´ Advisor</div>
                        <div class="stat-value" style="font-size: 1.2rem;" id="advisor-status">üôÇ Happy</div>
                        <div class="progress-bar">
                            <div class="progress-fill high" id="advisor-bar" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üì∞ Publications</div>
                        <div class="stat-value"><span id="papers">0</span> <span id="pub-breakdown"
                                style="font-size: 0.55rem; color: var(--text-secondary);">(0 J + 0 C)</span></div>
                        <div id="review-status" style="font-size: 0.7rem; margin-top: 2px;"></div>
                    </div>
                    <!-- V2.2 Pro: Peer Network -->
                    <div class="stat-card">
                        <div class="stat-label">ü§ù Network</div>
                        <div class="stat-value"><span id="peer-network">10</span></div>
                    </div>
                    <!-- V2.16: Strategic Alignment meter -->
                    <div class="stat-card">
                        <div class="stat-label">üéØ Alignment</div>
                        <div class="stat-value"><span id="alignment-value">0</span></div>
                        <div style="height: 4px; background: #333; border-radius: 2px; margin-top: 4px;">
                            <div id="alignment-bar"
                                style="height: 100%; width: 0%; background: linear-gradient(90deg, #f87171, #fbbf24, #4ade80); border-radius: 2px;">
                            </div>
                        </div>
                    </div>
                    <!-- V2.16: Quals Prep visualizer -->
                    <div class="stat-card" id="quals-prep-card" style="display: none;">
                        <div class="stat-label">üìö Quals Prep</div>
                        <div class="stat-value"><span id="quals-prep-value">0</span>/3</div>
                        <div id="quals-warning" style="font-size: 0.65rem;"></div>
                    </div>
                </div>

                <!-- V2.20: Event display with acknowledgement -->
                <div class="event-panel" style="display: flex; gap: 12px;">
                    <div style="flex: 2;">
                        <h3 style="font-size: 0.9rem; margin-bottom: 8px;">üì¢ What Happened</h3>
                        <div class="message-log" id="message-log" style="min-height: 80px;">Your PhD journey begins...
                        </div>
                        <button id="acknowledge-btn" class="action-btn" onclick="game.acknowledgeEvent()"
                            style="width: 100%; margin-top: 10px; display: none; background: linear-gradient(135deg, #22c55e, #16a34a);">
                            <div class="action-name">‚úì Continue</div>
                        </button>
                    </div>
                    <div style="flex: 1; opacity: 0.7;">
                        <h3 style="font-size: 0.9rem; margin-bottom: 8px;">üìú Previously</h3>
                        <div class="message-log" id="message-log-prev" style="min-height: 80px; font-size: 0.85rem;">-
                        </div>
                    </div>
                </div>

                <div class="main-content">
                    <div class="panel">
                        <h3>üìã Actions</h3>
                        <div class="actions-grid" id="actions"></div>
                    </div>

                    <div>
                        <div class="panel">
                            <h3>üî¨ Research Pipeline</h3>
                            <div id="pipeline"
                                style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; font-size: 0.85rem;">
                                <!-- Pipeline steps rendered by JS -->
                            </div>
                        </div>
                        <div class="panel">
                            <h3>‚ö° Status Effects</h3>
                            <div class="badge-list" id="statuses"><span class="empty-text">No effects</span></div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="action-btn save-btn" onclick="game.save()" style="flex: 1;">
                                <div class="action-name">üíæ Save</div>
                            </button>
                            <button class="action-btn save-btn" onclick="game.loadFromSave()" style="flex: 1;">
                                <div class="action-name">üìÇ Load</div>
                            </button>
                        </div>
                        <!-- V2.0.1: Footer buttons -->
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button class="action-btn save-btn" onclick="game.showHelp()"
                                style="flex: 1; padding: 6px;">
                                <div class="action-name" style="font-size: 0.85rem;">‚ùì Help</div>
                            </button>
                            <button class="action-btn save-btn" onclick="game.showSeed()"
                                style="flex: 1; padding: 6px;">
                                <div class="action-name" style="font-size: 0.85rem;">üé≤ Seed</div>
                            </button>
                            <button class="action-btn save-btn" onclick="game.showHistory()"
                                style="flex: 1; padding: 6px;">
                                <div class="action-name" style="font-size: 0.85rem;">üìú History</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- End Screen -->
            <div id="end-screen" class="end-screen panel" style="display: none;">
                <div id="end-title" style="font-size: 1.8rem; margin-bottom: 16px;">üéì Congratulations!</div>
                <div id="end-message" style="color: var(--text-secondary); margin-bottom: 20px;"></div>
                <div id="end-stats" style="margin-bottom: 30px;"></div>
                <button class="start-btn" onclick="game.restart()">üîÑ Play Again</button>
            </div>
        </div>
    </div>

    <!-- Thesis Modal -->
    <div class="modal-overlay" id="thesis-modal">
        <div class="modal">
            <h2>üìö Thesis Time!</h2>
            <p>You have enough papers to graduate. What would you like to do?</p>
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="game.thesisDefend()">üéì Defend Thesis</button>
                <button class="modal-btn secondary" onclick="game.thesisStay()">üìñ Stay for Research</button>
            </div>
        </div>
    </div>

    <!-- V2.2: History Modal -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal" style="max-width: 550px; text-align: left;">
            <div id="history-modal-content"></div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal" style="max-width: 600px; text-align: left; max-height: 85vh; overflow-y: auto;">
            <h2 style="text-align: center;">üìñ How to Play</h2>
            <div style="margin-top: 16px; line-height: 1.7; font-size: 0.95rem;">
                <p><strong>üéØ Goal:</strong> Publish 3 journal papers and defend your thesis!</p>

                <p style="margin-top: 14px;"><strong>üìä Research Pipeline:</strong></p>
                <p style="font-size: 0.9rem; color: var(--text-secondary);">
                    üìö Read ‚Üí üí° Idea ‚Üí üî¨ Findings ‚Üí üéØ Discovery ‚Üí üìä Figures (√ó3) ‚Üí üìù Paper
                </p>

                <p style="margin-top: 14px;"><strong>üìã Publication Tracks:</strong></p>
                <ul style="margin-left: 20px; font-size: 0.9rem;">
                    <li><strong>Journal Paper</strong>: 8-12 months, counts toward graduation</li>
                    <li><strong>Conference Paper</strong>: 4 months, builds network (+15)</li>
                </ul>

                <p style="margin-top: 14px;"><strong>üßë‚Äçüè´ Advisor System:</strong></p>
                <ul style="margin-left: 20px; font-size: 0.9rem;">
                    <li>Your advisor has hidden traits that affect outcomes</li>
                    <li>Use <strong>Pitch Session</strong> to learn their preferences</li>
                    <li>Signals: fast/slow response, harsh/encouraging tone</li>
                </ul>

                <p style="margin-top: 14px;"><strong>ü§ù Peer Network:</strong></p>
                <ul style="margin-left: 20px; font-size: 0.9rem;">
                    <li>Build through conferences and pitch sessions</li>
                    <li><strong>40+</strong>: Study Group (quals prep bonus)</li>
                    <li><strong>60+</strong>: Pre-register discount (-3 vs -5)</li>
                    <li><strong>80+</strong>: Peer Review Assist</li>
                </ul>

                <p style="margin-top: 14px;"><strong>üéØ Strategic Alignment:</strong></p>
                <ul style="margin-left: 20px; font-size: 0.9rem;">
                    <li>Increases through successful pitch sessions</li>
                    <li>Reduces monthly morale decay (-1 per 25 alignment)</li>
                    <li>Triggers advisor pep talks at high levels</li>
                </ul>

                <p style="margin-top: 14px;"><strong>üö™ Strategic Exits:</strong></p>
                <ul style="margin-left: 20px; font-size: 0.9rem;">
                    <li><strong>Master's Exit</strong>: Requires 30 credits + 18 months</li>
                    <li>Early Exit ‚Üí Career Pivot</li>
                    <li>Late Exit ‚Üí Technical Specialist (+salary)</li>
                </ul>

                <p style="margin-top: 14px;"><strong>‚ö†Ô∏è Key Events:</strong></p>
                <ul style="margin-left: 20px; font-size: 0.9rem;">
                    <li>Qual exam: September Year 2 (prep level 3+ to pass!)</li>
                    <li>First failure gives ONE retake chance (3 months)</li>
                    <li>Imposter syndrome, getting scooped, teaching duty</li>
                    <li>Reviewer #2 may request major revisions</li>
                </ul>

                <p style="margin-top: 14px;"><strong>üè• Emergency Options:</strong></p>
                <ul style="margin-left: 20px; font-size: 0.9rem;">
                    <li><strong>Medical Leave</strong>: +40 morale when critical, costs 3-6 months (one-time)</li>
                    <li><strong>Vacation</strong>: Advisor may suggest rest when morale low</li>
                    <li>After 2 failed figures: learning bonus (+30% success)</li>
                </ul>
            </div>
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="game.hideHelp()">Got it!</button>
            </div>
        </div>
    </div>

    <script>
        // GradQuest - Pure JavaScript Game Engine
        const game = {
            state: null,

            // ===========================================
            // CONSTANTS - All thresholds in one place
            // ===========================================
            CONST: {
                // Morale thresholds
                MORALE_CRITICAL: 15,
                MORALE_LOW: 30,
                MORALE_OK: 50,
                MORALE_GOOD: 75,
                // Credits & Time
                MS_OUT_CREDITS: 30,
                MS_OUT_MONTHS: 18,
                CREDITS_PER_MONTH: 3,
                // Network thresholds
                NETWORK_STUDY_GROUP: 40,
                NETWORK_PREREG_DISCOUNT: 60,
                NETWORK_PEER_ASSIST: 80,
                // Semester months
                SPRING: { start: 1, end: 5 },
                SUMMER: { start: 6, end: 7 },
                FALL: { start: 8, end: 12 },
                // Decay rates
                BASE_DECAY: 4,
                EXHAUSTION_DECAY: 6,
                UNHAPPY_ADVISOR_DECAY: 6,
                TA_DECAY: 3,
                // Cooldowns
                SCOOP_COOLDOWN: 24,
                HIGH_THROUGHPUT_COOLDOWN: 6,
                EQUIPMENT_STABLE_MONTHS: 12
            },

            // ===========================================
            // V2.19: RULESET OVERLAYS (Architectural Boundaries)
            // Precedence: base < difficulty < regional
            // ===========================================
            RULES: {
                base: {
                    morale_decay: 4,
                    conf_cap_per_year: 2,
                    scoop_prob: 0.05,
                    quals_pass_threshold: 3,
                    papers_to_graduate: 3,
                    inspiration_morale_mult: 1.0
                },
                difficulty: {
                    standard: {},  // Uses base values
                    easy: {
                        morale_decay: 3,
                        scoop_prob: 0.02
                    },
                    brutal: {
                        morale_decay: 5,
                        conf_cap_per_year: 1,
                        scoop_prob: 0.10,
                        inspiration_morale_mult: 0
                    }
                },
                regional: {}  // Future expansion
            },

            currentDifficulty: 'standard',

            // ===========================================
            // V2.20: FIELD SPECIALIZATIONS
            // Each specialization has unique modifiers, accelerators, and events
            // ===========================================
            SPECIALIZATIONS: {
                experimentalist: {
                    name: 'üî¨ Experimentalist',
                    desc: 'Lab-based research with hands-on experiments',
                    modifiers: {
                        equipment_fail_chance: 1.5,   // Higher equipment risk
                        idea_generation: 0.8,        // Slower ideas
                        figure_quality: 1.2          // Better figures
                    },
                    accelerator: {
                        name: 'Protocol Reuse',
                        desc: 'After first Figure, next needs 1 fewer step',
                        effect: 'figure_steps_reduction'
                    },
                    events: ['equipment_failure', 'lab_accident', 'reagent_shortage'],
                    collaboration_bonus: { figures: 1, morale: 3 },
                    warning: '‚ö†Ô∏è Equipment-dependent'
                },
                theoretician: {
                    name: 'üìê Theoretician',
                    desc: 'Mathematical and conceptual research',
                    modifiers: {
                        equipment_fail_chance: 0.2,  // Minimal equipment
                        idea_generation: 1.3,        // Faster ideas
                        figure_quality: 0.9          // Harder to visualize
                    },
                    accelerator: {
                        name: 'Conceptual Breakthrough',
                        desc: 'Once per year, auto-generate an Idea',
                        effect: 'yearly_idea'
                    },
                    events: ['proof_error', 'notation_confusion', 'reviewer_pedantry'],
                    collaboration_bonus: { alignment: 2, discovery_progress: 30 },
                    warning: '‚ö†Ô∏è Abstract results'
                },
                computational: {
                    name: 'üíª Computational',
                    desc: 'Data-driven and simulation-based research',
                    modifiers: {
                        equipment_fail_chance: 0.8,  // Servers can crash
                        idea_generation: 1.0,        // Normal
                        figure_quality: 1.1          // Automated plots
                    },
                    accelerator: {
                        name: 'Pipeline Automation',
                        desc: 'Reduce Develop Findings time by 1 month',
                        effect: 'findings_speedup'
                    },
                    events: ['server_crash', 'data_corruption', 'dependency_hell'],
                    collaboration_bonus: { figures: 1, equipment_immunity: 2 },
                    warning: '‚ö†Ô∏è Server-dependent'
                }
            },

            // Get merged rule value with precedence
            getRule(key) {
                const base = this.RULES.base[key];
                const diff = this.RULES.difficulty[this.currentDifficulty]?.[key];
                const regional = this.RULES.regional?.[key];
                return regional ?? diff ?? base;
            },

            // ===========================================
            // V2.18: CAREER ENDINGS SYSTEM
            // Determines player's post-degree career path
            // ===========================================
            CAREER_ENDINGS: {
                // PhD Path Endings (ordered by prestige, highest first)
                phd: [
                    {
                        id: 'tenure_track_professor',
                        name: 'üèõÔ∏è Tenure-Track Professor',
                        conditions: { papers: 4, network: 80, alignment: 70 },
                        desc: 'The holy grail. You secured a position at an R1 institution. Your advisor\'s advocacy was the final key.',
                        emoji: 'üéìüë®‚Äçüè´'
                    },
                    {
                        id: 'industry_rd_director',
                        name: 'üè¢ R&D Director',
                        conditions: { papers: 3, network: 90, internship: true },
                        desc: 'You traded the ivory tower for a corner office. Your massive network ensured a seamless transition.',
                        emoji: 'üíºüî¨'
                    },
                    {
                        id: 'research_scientist',
                        name: 'üî¨ Research Scientist',
                        conditions: { papers: 3, network: 50 },
                        desc: 'A stable career at a national lab or research institute. Not flashy, but fulfilling.',
                        emoji: 'üß™üìä'
                    },
                    {
                        id: 'academic_martyr',
                        name: 'üìö Permanent Post-doc',
                        conditions: { papers: 3, morale_low: true },
                        desc: 'You have the degree, but at what cost? You continue the grind, one-year contract after one-year contract.',
                        emoji: 'üòìüìÑ'
                    }
                ],
                // MS-Out Path Endings
                ms: [
                    {
                        id: 'startup_founder',
                        name: 'üöÄ Tech Startup Founder',
                        conditions: { network: 70, ideas: 5 },
                        desc: 'You took your half-finished discovery and turned it into a seed-round deck. Disruption awaits.',
                        emoji: 'üí°ü¶Ñ'
                    },
                    {
                        id: 'data_scientist',
                        name: 'üìä Data Scientist',
                        conditions: { papers: 1 },
                        desc: 'Your ability to survive Reviewer #2 made you overqualified for industry analytics. +15% salary boost.',
                        emoji: 'üíªüìà'
                    },
                    {
                        id: 'great_escape',
                        name: 'üåÖ The Great Escape',
                        conditions: { morale_low: true },
                        desc: 'You left academia and never looked back. Your health is recovering, and you\'ve rediscovered hobbies.',
                        emoji: 'üèñÔ∏èüòå'
                    },
                    {
                        id: 'career_pivot',
                        name: 'üîÑ Career Pivot',
                        conditions: {},
                        desc: 'The skills you gained opened unexpected doors. The PhD wasn\'t the destination, but the journey mattered.',
                        emoji: 'üö™‚ú®'
                    }
                ]
            },

            // Resolve career ending based on game state
            resolveCareerEnding(exitType) {
                const s = this.state;
                const papers = (this.getItem('paper') || 0) + Math.floor((s.confPaperCount || 0) / 2);
                const network = s.peerNetwork || 0;
                const alignment = s.strategicAlignment || 0;
                const morale = s.morale || 0;
                const ideas = s.telemetry?.inspirationCount || 0;
                const hasInternship = s.internshipCompleted || false;

                const endings = exitType === 'PhD' ? this.CAREER_ENDINGS.phd : this.CAREER_ENDINGS.ms;

                for (const ending of endings) {
                    const c = ending.conditions;
                    let match = true;

                    if (c.papers !== undefined && papers < c.papers) match = false;
                    if (c.network !== undefined && network < c.network) match = false;
                    if (c.alignment !== undefined && alignment < c.alignment) match = false;
                    if (c.ideas !== undefined && ideas < c.ideas) match = false;
                    if (c.internship && !hasInternship) match = false;
                    if (c.morale_low && morale >= 20) match = false;

                    if (match) return ending;
                }

                // Fallback
                return exitType === 'PhD'
                    ? { id: 'phd_default', name: 'üéì PhD Graduate', desc: 'You earned your degree. The future is unwritten.', emoji: 'üéì' }
                    : this.CAREER_ENDINGS.ms[this.CAREER_ENDINGS.ms.length - 1];
            },

            // ===========================================
            // V2.21: STRESS & INTERVENTION SYSTEM
            // Stress ladder: 0-59 Normal, 60-99 Stressed, 100+ Exhausted
            // ===========================================

            // Get current stress level status
            getStressLevel() {
                const stress = this.state.stress || 0;
                if (stress >= 100) return 'exhausted';
                if (stress >= 60) return 'stressed';
                return 'normal';
            },

            // V2.21: Check and apply advisor intervention (passive + active)
            checkAdvisorIntervention() {
                const s = this.state;
                const alignment = s.strategicAlignment || 0;
                const cooldownPassed = (s.totalMonths - (s.lastAdvisorInterventionMonth || 0)) >= 12;

                // Passive Shield: alignment >= 40 reduces penalties by 25%
                const hasPassiveShield = alignment >= 40;

                // Active Intervention: alignment >= 60, off cooldown, in crisis
                if (alignment >= 60 && cooldownPassed && (s.morale < 20 || s.stress >= 100)) {
                    s.lastAdvisorInterventionMonth = s.totalMonths;

                    // Clear Exhaustion status if present
                    if (this.hasStatus('exhaustion')) {
                        this.removeStatus('exhaustion');
                    }
                    if (this.hasStatus('burnout')) {
                        this.removeStatus('burnout');
                    }

                    // Stress relief
                    s.stress = Math.max(0, s.stress - 40);
                    s.morale = Math.min(100, s.morale + 15);

                    this.appendAdvisorEvent('Your advisor noticed you struggling and scheduled a supportive meeting. (+15 morale, stress reduced)');
                    return true;
                }

                return hasPassiveShield; // Return passive status for penalty reduction
            },

            // V2.21: Check and apply peer intervention (network safety net)
            checkPeerIntervention() {
                const s = this.state;
                const network = s.peerNetwork || 0;
                const cooldownPassed = (s.totalMonths - (s.lastPeerInterventionMonth || 0)) >= 6;

                // Peer intervention: network >= 60, morale < 30, off cooldown
                if (network >= 60 && s.morale < 30 && cooldownPassed) {
                    s.lastPeerInterventionMonth = s.totalMonths;
                    s.stress = Math.max(0, s.stress - 30);
                    s.morale = Math.min(100, s.morale + 10);

                    this.appendRandomEvent('ü§ù Your labmates noticed you disappearing and invited you for coffee. "We\'ve all been there." (+10 morale, ‚àí30 stress)');
                    return true;
                }
                return false;
            },

            // V2.21: Calculate morale projection for next month
            calculateMoraleProjection() {
                const s = this.state;
                let decay = this.getRule('morale_decay');

                // Exhaustion penalty
                if (this.hasStatus('exhaustion')) decay += 2;
                if (this.hasStatus('burnout')) decay += 4;

                // Alignment buffer
                const alignmentBuffer = Math.floor((s.strategicAlignment || 0) / 25);

                // New Lease buff
                if (s.newLeaseUntil && s.totalMonths < s.newLeaseUntil) {
                    decay = Math.floor(decay / 2);
                }

                const projected = s.morale - decay + alignmentBuffer;
                return {
                    current: s.morale,
                    projected: Math.max(0, projected),
                    decay: decay,
                    buffer: alignmentBuffer
                };
            },

            // ===========================================
            // V2.19: GAME MODE SYSTEM
            // Automatically switches based on game state
            // ===========================================
            updateGameMode() {
                const s = this.state;
                const papers = (this.getItem('paper') || 0) + Math.floor((s.confPaperCount || 0) / 2);

                // FINALE: 3+ papers and thesis prep done
                if (papers >= 3 && s.defensePrepared) {
                    if (s.gameMode !== 'FINALE') {
                        s.gameMode = 'FINALE';
                        this.appendSystemEvent('üéì DEFENSE MODE: Time to finish your thesis!');
                    }
                    return;
                }

                // QUALS_WINDOW: Year 2, approaching quals (months 6-9)
                if (!s.qualsPassed && s.year === 2 && s.month >= 6 && s.month <= 9) {
                    if (s.gameMode !== 'QUALS_WINDOW') {
                        s.gameMode = 'QUALS_WINDOW';
                        this.appendSystemEvent('üìö QUALS WINDOW: Focus on exam preparation!');
                    }
                    return;
                }

                // PROBATION: Very low morale or advisor unhappy
                if (s.morale < 15 || s.advisorScore < 20) {
                    if (s.gameMode !== 'PROBATION') {
                        s.gameMode = 'PROBATION';
                        this.appendSystemEvent('‚ö†Ô∏è CRISIS MODE: Address your situation immediately!');
                    }
                    return;
                }

                // Default to NORMAL
                if (s.gameMode !== 'NORMAL') {
                    s.gameMode = 'NORMAL';
                }
            },

            // V2.19: Get mode-specific action limit
            getModeActionCategories() {
                const mode = this.state.gameMode;
                switch (mode) {
                    case 'QUALS_WINDOW':
                        return ['quals', 'advisor', 'wellness'];
                    case 'PROBATION':
                        return ['wellness', 'advisor', 'emergency'];
                    case 'FINALE':
                        return ['thesis', 'wellness'];
                    default:
                        return null; // All actions available
                }
            },

            // Month names
            months: ["", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],

            // Helper: Get current semester name
            getSemester(month) {
                const m = month || this.state.month;
                if (m >= this.CONST.SPRING.start && m <= this.CONST.SPRING.end) return 'Spring';
                if (m >= this.CONST.SUMMER.start && m <= this.CONST.SUMMER.end) return 'Summer';
                return 'Fall';
            },

            // Helper: Check if in academic semester (Spring or Fall, not Summer)
            isAcademicSemester(month) {
                const m = month || this.state.month;
                return (m >= this.CONST.SPRING.start && m <= this.CONST.SPRING.end) ||
                    (m >= this.CONST.FALL.start && m <= this.CONST.FALL.end);
            },

            // ===========================================
            // DOM CACHE - Cached references for performance
            // ===========================================
            dom: null,

            // Initialize DOM cache (call once after game screen visible)
            initDOM() {
                this.dom = {
                    startScreen: document.getElementById('start-screen'),
                    gameScreen: document.getElementById('game-screen'),
                    endScreen: document.getElementById('end-screen'),
                    date: document.getElementById('date'),
                    totalMonths: document.getElementById('total-months'),
                    semester: document.getElementById('semester'),
                    credits: document.getElementById('credits-display'),
                    papers: document.getElementById('papers'),
                    pubBreakdown: document.getElementById('pub-breakdown'),
                    reviewStatus: document.getElementById('review-status'),
                    peerNetwork: document.getElementById('peer-network'),
                    alignmentValue: document.getElementById('alignment-value'),
                    alignmentBar: document.getElementById('alignment-bar'),
                    qualsCard: document.getElementById('quals-prep-card'),
                    qualsValue: document.getElementById('quals-prep-value'),
                    qualsWarning: document.getElementById('quals-warning'),
                    moraleBar: document.getElementById('morale-bar'),
                    moraleStatus: document.getElementById('morale-status'),
                    advisorBar: document.getElementById('advisor-bar'),
                    advisorStatus: document.getElementById('advisor-status'),
                    actions: document.getElementById('actions'),
                    pipeline: document.getElementById('pipeline'),
                    statuses: document.getElementById('statuses'),
                    messageLog: document.getElementById('message-log'),
                    messageLogPrev: document.getElementById('message-log-prev'),
                    endTitle: document.getElementById('end-title'),
                    endMessage: document.getElementById('end-message'),
                    endStats: document.getElementById('end-stats')
                };
            },

            // ===========================================
            // V2.18: IMMUTABLE STATE UPDATES
            // ===========================================
            updateState(changes) {
                this.state = { ...this.state, ...changes };
                if (Object.keys(changes).length <= 3) {
                    console.log('[STATE]', changes);
                }
            },

            // ===========================================
            // V2.18: VARIANT MESSAGES (3+ per action)
            // ===========================================
            MESSAGES: {
                read: [
                    'üìö You read papers and found a promising idea!',
                    'üìö A paper sparks inspiration!',
                    'üìö You discover an interesting research direction!'
                ],
                read_fail: [
                    'üìö Nothing clicks today. Keep trying.',
                    'üìö The papers blur together. No ideas yet.',
                    'üìö Another day of reading without a breakthrough.'
                ],
                experiment: [
                    'üî¨ Your experiment reveals initial findings!',
                    'üî¨ The data looks promising!',
                    'üî¨ You collect some interesting results!'
                ],
                experiment_fail: [
                    'üî¨ The experiment fails. You learn what NOT to do.',
                    'üî¨ No usable data today. Science is hard.',
                    'üî¨ Equipment issues. Try again next time.'
                ],
                break: [
                    '‚òï You take a break and feel refreshed!',
                    '‚òï A walk clears your mind.',
                    '‚òï Some rest does you good.'
                ],
                quals_pass: [
                    'üéì You passed your qualifying exam!',
                    'üéì Quals conquered! One milestone down.',
                    'üéì Your committee was impressed!'
                ],
                quals_fail: [
                    'üìù You failed quals. You can retake next year.',
                    'üìù The committee has concerns. Try again later.',
                    'üìù Not ready yet. More preparation needed.'
                ],
                conference: [
                    'üé§ Great networking at the conference!',
                    'üé§ You met interesting researchers!',
                    'üé§ The conference expanded your horizons!'
                ]
            },

            // Get random message variant
            getMessage(key) {
                const variants = this.MESSAGES[key];
                if (!variants || variants.length === 0) return null;
                return this.pick(variants);
            },

            // ===========================================
            // V2.19: GAMESTATE ‚Üí UISTATE TRANSFORMER
            // Separates game logic from UI rendering
            // ===========================================

            // Helper: Get morale display class
            getMoraleClass(morale) {
                if (morale > this.CONST.MORALE_OK) return 'high';
                if (morale > this.CONST.MORALE_LOW) return 'medium';
                return 'low';
            },

            // Helper: Get morale display text
            getMoraleText(morale) {
                if (morale > this.CONST.MORALE_GOOD) return 'üòÑ Great';
                if (morale > this.CONST.MORALE_OK) return 'üòä Good';
                if (morale > this.CONST.MORALE_LOW) return 'üòê Okay';
                if (morale > this.CONST.MORALE_CRITICAL) return 'üòü Low';
                return 'üò∞ Critical';
            },

            // Helper: Get advisor display class
            getAdvisorClass(score) {
                const hasUnhappy = this.hasStatus('unhappyAdvisor');
                if (hasUnhappy || score < this.CONST.MORALE_LOW) return 'low';
                if (score < this.CONST.MORALE_OK) return 'medium';
                return 'high';
            },

            // Helper: Get advisor display text
            getAdvisorText(score) {
                const hasUnhappy = this.hasStatus('unhappyAdvisor');
                if (hasUnhappy || score < this.CONST.MORALE_LOW) return 'üò† Unhappy';
                if (score < this.CONST.MORALE_OK) return 'üòê Neutral';
                return 'üôÇ Happy';
            },

            // Helper: Get quals warning state
            getQualsWarning(s) {
                const monthsToQuals = (2 * 12 + 9) - s.totalMonths;
                if (s.year === 2 && s.month >= 6 && monthsToQuals <= 3) {
                    return { text: 'üö® <b>IMMINENT!</b>', color: '#f87171', border: '#f87171' };
                } else if (s.year === 2) {
                    return { text: '‚ö†Ô∏è This year', color: '#fbbf24', border: '#fbbf24' };
                }
                return { text: '', color: '', border: '' };
            },

            // Transform GameState ‚Üí UIState (derived display values)
            toUIState() {
                const s = this.state;
                const journalPapers = this.getItem('paper') || 0;
                const confPapers = s.confPaperCount || 0;
                const journalEquivalent = journalPapers + Math.floor(confPapers / 2);

                return {
                    // Date & Time
                    dateText: `${this.months[s.month]}, Year ${s.year}`,
                    semester: this.getSemester(),
                    totalMonths: s.totalMonths,
                    credits: s.credits || 0,

                    // Publications
                    totalPubs: journalPapers + confPapers,
                    journalPapers: journalPapers,
                    confPapers: confPapers,
                    pubBreakdown: `(${journalPapers} J + ${confPapers} C)`,
                    journalEquivalent: journalEquivalent,
                    papersUntilDefense: Math.max(0, this.getRule('papers_to_graduate') - journalEquivalent),

                    // Pending reviews
                    pendingJournal: (s.pendingPapers || []).length,
                    pendingConf: (s.pendingConference || []).length,

                    // Progress bars
                    morale: s.morale,
                    moraleClass: this.getMoraleClass(s.morale),
                    moraleText: this.getMoraleText(s.morale),
                    advisorScore: s.advisorScore,
                    advisorClass: this.getAdvisorClass(s.advisorScore),
                    advisorText: this.getAdvisorText(s.advisorScore),

                    // Quals
                    qualsVisible: !s.qualsPassed && (s.year >= 1 || s.totalMonths >= 6),
                    qualsPassed: s.qualsPassed,
                    qualsLevel: s.qualifyLevel || 0,
                    qualsWarning: this.getQualsWarning(s),

                    // V2.19: Quals Countdown (Month 10 of Year 1 = 3 months until Sept Year 2)
                    qualsCountdown: !s.qualsPassed ? this.getQualsCountdown(s) : null,

                    // Alignment & Network
                    alignment: s.strategicAlignment || 0,
                    network: s.peerNetwork || 10,

                    // V2.19: Game Mode
                    gameMode: s.gameMode || 'NORMAL',
                    gameModeLabel: this.getGameModeLabel(s.gameMode),

                    // V2.19: Defense Tracks (for FINALE mode)
                    defenseState: s.defenseState,
                    defenseReady: s.defenseState &&
                        (s.defenseState.thesis_quality >= 60 ? 1 : 0) +
                        (s.defenseState.presentation_skill >= 60 ? 1 : 0) +
                        (s.defenseState.committee_support >= 60 ? 1 : 0) >= 2,

                    // Game state flags
                    isEnded: s.isEnded,
                    endState: s.endState
                };
            },

            // V2.19: Get Quals countdown for banner
            getQualsCountdown(s) {
                const qualsMonth = 2 * 12 + 9; // September Year 2
                const monthsUntil = qualsMonth - s.totalMonths;
                if (monthsUntil <= 0) return null;
                if (monthsUntil > 12) return null; // Don't show until Year 1 Sept

                let color = '#94a3b8'; // neutral gray
                if (monthsUntil <= 3) color = '#f87171'; // red
                else if (monthsUntil <= 6) color = '#fbbf24'; // yellow

                return {
                    months: monthsUntil,
                    color: color,
                    text: monthsUntil === 1 ? '1 month until Quals!' : `${monthsUntil} months until Quals`
                };
            },

            // V2.19: Get game mode label
            getGameModeLabel(mode) {
                switch (mode) {
                    case 'QUALS_WINDOW': return 'üìö Quals Focus';
                    case 'PROBATION': return '‚ö†Ô∏è Crisis Mode';
                    case 'FINALE': return 'üéì Defense Time';
                    default: return null;
                }
            },

            // ===========================================
            // V2.19: TELEMETRY EXPORT (Balance & Calibration)
            // ===========================================
            exportTelemetry() {
                const s = this.state;
                const t = s.telemetry;
                const journalPapers = this.getItem('paper') || 0;
                const confPapers = s.confPaperCount || 0;

                return {
                    // Primary Metrics (from ASPIRATIONAL_STANDARDS)
                    completionMonths: s.totalMonths,
                    inspirationFrequency: t.inspirationCount,
                    conferenceDensity: s.totalMonths > 0 ? (t.conferenceCount / (s.totalMonths / 12)).toFixed(2) : 0,

                    // Publication Stats
                    journalPapers: journalPapers,
                    confPapers: confPapers,
                    journalEquivalent: journalPapers + Math.floor(confPapers / 2),

                    // Event Tracking
                    scoopCount: t.scoopCount,
                    moraleLowMonths: t.moraleLowMonths,

                    // Milestones
                    qualsPassedMonth: t.qualsPassedMonth,
                    firstPaperMonth: t.firstPaperMonth,

                    // Failure Diagnostics
                    msOutState: t.msOutState,
                    endReason: t.endReason,

                    // Action Distribution
                    actionCounts: t.actionCounts,

                    // Game Info
                    seed: this.seed,
                    difficulty: this.currentDifficulty,
                    won: s.endState?.won || false
                };
            },

            // V1.7: Seed for reproducible randomness
            seed: null,
            seedState: null,

            // V1.7: Seeded random number generator
            random() {
                if (!this.seedState) {
                    this.seedState = this.seed || Math.floor(Math.random() * 999999);
                }
                this.seedState = (this.seedState * 1103515245 + 12345) & 0x7fffffff;
                return (this.seedState / 0x7fffffff);
            },

            // Initialize new game state
            initState() {
                return {
                    year: 1,
                    month: 9,
                    morale: 50,
                    advisorScore: 50,
                    qualifyLevel: 0,
                    qualsPassed: false,
                    items: {},
                    statuses: new Set(['firstYear']),
                    equipmentBrokenMonths: 0,
                    totalMonths: 1,
                    isRunning: true,
                    isEnded: false,
                    endState: null,
                    conferencesThisYear: 0,
                    pendingPapers: [],
                    // V2.1: Teaching duty
                    isTeaching: false,
                    teachingMonths: 0,
                    // V2.2 Pro: Advisor profiling
                    advisor: {
                        riskTolerance: 30 + Math.floor(Math.random() * 40),  // 30-70
                        attentionSpan: 30 + Math.floor(Math.random() * 40),  // 30-70
                        strictness: 30 + Math.floor(Math.random() * 40)       // 30-70
                    },
                    // V2.2 Pro: Peer network and strategic alignment
                    peerNetwork: 10,
                    strategicAlignment: 0,
                    // V2.2 Pro: Track pending by type
                    pendingConference: [],
                    confPaperCount: 0, // V2.5: Published conference papers
                    msOutOffered: false,
                    // V2.7: Advisor fatigue and vacation cooldown
                    advisorInterventions: 0, // How many times advisor suggested vacation
                    lastVacationMonth: 0,    // Month of last vacation
                    vacationsThisYear: 0,    // Vacations taken this year
                    // V2.8: Inspiration and scoop tracking
                    inspirationsThisYear: 0, // Cap at 2/year
                    lastScoopMonth: 0,       // 6-month scoop cooldown
                    // V2.15: Coursework credits and dead-end learning
                    credits: 0,              // Need 30 for MS-Out
                    deadEndReduction: 0,     // -5% per dead-end experienced
                    // V2.18: Defense prep gate and advisor patience
                    defensePrepared: false,  // Must prepare defense before graduating
                    advisorPatienceExhausted: false, // After 3+ interventions

                    // V2.20: Field Specialization
                    specialization: null,    // Set at game start: experimentalist, theoretician, computational
                    secondaryFocus: null,    // Unlocks at Month >= 24, partial modifiers
                    socialDebt: 0,           // Increases collaboration cost (+10 per use, decays -10/6mo)
                    lastCollabMonth: 0,      // For social debt decay
                    figuresThisRun: 0,       // For Protocol Reuse accelerator
                    yearlyIdeaUsed: false,   // For Conceptual Breakthrough accelerator

                    // V2.19: Game Mode System (action gating)
                    gameMode: 'NORMAL', // NORMAL, QUALS_WINDOW, PROBATION, FINALE

                    // V2.19: Defense 3-Track System
                    defenseState: {
                        thesis_quality: 0,      // From figures, polish, papers
                        presentation_skill: 0,  // From practice, teaching, network
                        committee_support: 0    // From alignment, advisor, past conflicts
                    },

                    // V2.19: Committee Personalities (lightweight NPCs)
                    committee: [
                        { name: 'Prof. Chen', tag: 'Methodology Hawk', bias: 'thesis_quality' },
                        { name: 'Prof. Smith', tag: 'Industry Friendly', bias: 'presentation_skill' },
                        { name: 'Prof. Alvarez', tag: 'Silent but Deadly', bias: 'committee_support' }
                    ],

                    // V2.19: Milestones tracking
                    milestones: {
                        quals: { status: 'locked', month: null },
                        firstPaper: { status: 'locked', month: null },
                        defense: { status: 'locked', month: null }
                    },

                    // V2.21: Stress System (replaces binary exhaustion)
                    stress: 0,                      // 0-100, 60=Stressed, 100=Exhausted
                    lastAdvisorInterventionMonth: 0, // 12-month cooldown
                    lastPeerInterventionMonth: 0,    // 6-month cooldown
                    qualsGraceUsed: false,           // First quals failure is protected

                    // V2.2: Event log for history
                    eventLog: [],
                    // V2.19: Telemetry for Balance Calibration
                    telemetry: {
                        inspirationCount: 0,       // Total inspirations (target < 4)
                        scoopCount: 0,             // Total scoop events
                        conferenceCount: 0,        // Conferences attended
                        actionCounts: {},          // Count by action type
                        moraleLowMonths: 0,        // Months spent below 30%
                        msOutState: null,          // Snapshot at MS-Out prompt
                        qualsPassedMonth: null,    // Month quals passed
                        firstPaperMonth: null,     // Month first paper published
                        endReason: null            // Win/Loss reason
                    }
                };
            },

            // V1.8: Pick random from array
            pick(arr) {
                return arr[Math.floor(this.random() * arr.length)];
            },

            // Random number generator
            random() {
                return Math.random();
            },

            // V2.20: Track selected specialization before game start
            selectedSpecialization: null,

            // V2.20: Handle specialization selection on start screen
            selectSpecialization(specId) {
                this.selectedSpecialization = specId;
                const spec = this.SPECIALIZATIONS[specId];

                // Update UI - highlight selected card
                document.querySelectorAll('.spec-card').forEach(card => {
                    card.style.border = '2px solid transparent';
                    card.style.opacity = '0.6';
                });
                const selectedCard = document.getElementById('spec-' + specId);
                if (selectedCard) {
                    selectedCard.style.border = '2px solid var(--accent-blue)';
                    selectedCard.style.opacity = '1';
                }

                // Show selection confirmation
                document.getElementById('spec-selected').textContent = `Selected: ${spec.name}`;

                // Enable start button
                const startBtn = document.getElementById('start-game-btn');
                if (startBtn) {
                    startBtn.disabled = false;
                    startBtn.style.opacity = '1';
                }
            },

            // Start new game
            start() {
                // V2.20: Require specialization selection
                if (!this.selectedSpecialization) {
                    alert('Please select a research field first!');
                    return;
                }

                // V1.7: Check for seed in URL
                const urlParams = new URLSearchParams(window.location.search);
                this.seed = urlParams.get('seed') ? parseInt(urlParams.get('seed')) : Math.floor(Math.random() * 999999);
                this.seedState = this.seed;

                this.state = this.initState();

                // V2.20: Apply selected specialization
                this.state.specialization = this.selectedSpecialization;
                const spec = this.SPECIALIZATIONS[this.selectedSpecialization];

                this.initDOM(); // Initialize DOM cache
                this.showMessage(`üéì Welcome to your PhD program!\n\n${spec.name}: ${spec.desc}\n\n‚ú® Bonus: ${spec.accelerator.desc}\n\nYour goal: publish 3 papers and defend your thesis.`);
                this.dom.startScreen.style.display = 'none';
                this.dom.gameScreen.style.display = 'block';
                this.updateUI();
            },

            // Restart game
            restart() {
                localStorage.removeItem('gradquest_save');
                document.getElementById('end-screen').style.display = 'none';
                this.start();
            },

            // Save game
            save() {
                const saveData = {
                    ...this.state,
                    statuses: Array.from(this.state.statuses),
                    version: '2.21'
                };
                localStorage.setItem('gradquest_save', JSON.stringify(saveData));
                alert('üíæ Game saved!');
            },

            // Load game
            load() {
                const data = localStorage.getItem('gradquest_save');
                if (!data) {
                    alert('No saved game found!');
                    return;
                }
                const saveData = JSON.parse(data);
                this.state = {
                    ...saveData,
                    statuses: new Set(saveData.statuses)
                };
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'block';
                this.updateUI();
            },

            // Check for saved game on page load
            checkSave() {
                if (localStorage.getItem('gradquest_save')) {
                    document.getElementById('load-btn').style.display = 'inline-block';
                }
            },

            // Get item count
            getItem(id) {
                return this.state.items[id] || 0;
            },

            // Add item - V2.7: Hard bounds to prevent overshoot
            addItem(id, count = 1) {
                const bounds = { figure: 3, idea: 5, key_discovery: 3 };
                const current = this.state.items[id] || 0;
                const max = bounds[id] || 99;
                this.state.items[id] = Math.min(max, current + count);
            },

            // Remove item
            removeItem(id, count = 1) {
                this.state.items[id] = Math.max(0, (this.state.items[id] || 0) - count);
                if (this.state.items[id] === 0) delete this.state.items[id];
            },

            // Check status
            hasStatus(id) {
                return this.state.statuses.has(id);
            },

            // Add status
            addStatus(id) {
                this.state.statuses.add(id);
            },

            // Remove status
            removeStatus(id) {
                this.state.statuses.delete(id);
            },

            // V1.9: Load game from within gameplay
            loadFromSave() {
                const data = localStorage.getItem('gradquest_save');
                if (!data) {
                    alert('No saved game found!');
                    return;
                }
                if (confirm('Load saved game? Current progress will be lost.')) {
                    const saveData = JSON.parse(data);
                    this.state = {
                        ...saveData,
                        statuses: new Set(saveData.statuses)
                    };
                    this.updateUI();
                    this.showMessage('üìÇ Game loaded!');
                }
            },

            // V2.4: Typewriter effect with dual display
            typeTimer: null,
            previousEvent: '', // V2.20: Track last event (not last month)
            waitingForAcknowledge: false, // V2.20: Block actions until acknowledged

            showMessage(msg) {
                const el = document.getElementById('message-log');
                const prevEl = document.getElementById('message-log-prev');
                const ackBtn = document.getElementById('acknowledge-btn');
                if (this.typeTimer) clearInterval(this.typeTimer);

                // V2.20: Shift current event to "Previously"
                const currentText = el.textContent.trim();
                if (prevEl && currentText && currentText !== 'Your PhD journey begins...' && currentText !== '-') {
                    this.previousEvent = currentText;
                    prevEl.textContent = this.previousEvent;
                }

                // Display new message with typewriter effect
                el.textContent = '';
                let i = 0;
                this.typeTimer = setInterval(() => {
                    el.textContent += msg[i++];
                    if (i >= msg.length) {
                        clearInterval(this.typeTimer);
                        // V2.20: Show acknowledge button after message completes
                        if (ackBtn) {
                            ackBtn.style.display = 'block';
                            this.waitingForAcknowledge = true;
                        }
                    }
                }, 15);

                // V2.2: Log to event history
                if (this.state && this.state.eventLog) {
                    this.state.eventLog.push({ month: this.state.totalMonths, text: msg });
                }
            },

            // V2.20: User acknowledges event to continue
            acknowledgeEvent() {
                const ackBtn = document.getElementById('acknowledge-btn');
                if (ackBtn) {
                    ackBtn.style.display = 'none';
                }
                this.waitingForAcknowledge = false;
                this.updateUI(); // Refresh actions
            },

            // Append message
            appendMessage(msg) {
                const el = document.getElementById('message-log');
                if (this.typeTimer) clearInterval(this.typeTimer);
                const current = el.textContent.trim();
                const separator = current ? '\n' : '';

                el.textContent = current + separator;
                let i = 0;
                this.typeTimer = setInterval(() => {
                    el.textContent = current + separator + msg.slice(0, ++i);
                    if (i >= msg.length) clearInterval(this.typeTimer);
                }, 15);
                // V2.2: Log to event history
                if (this.state && this.state.eventLog) {
                    this.state.eventLog.push({ month: this.state.totalMonths, text: msg });
                }
            },

            // V2.14: Append random event with subtle visual distinction
            appendRandomEvent(msg) {
                const prefix = 'üé≤ ';
                this.appendMessage(prefix + msg);
            },

            // V2.16: Append advisor intervention event
            appendAdvisorEvent(msg) {
                const prefix = 'üßë‚Äçüè´ ';
                this.appendMessage(prefix + msg);
            },

            // V2.16: Append system pressure event
            appendSystemEvent(msg) {
                const prefix = '‚ö†Ô∏è ';
                this.appendMessage(prefix + msg);
            },

            // V2.5: Show full event history modal
            showHistory() {
                const log = this.state.eventLog || [];
                const allEvents = log.slice().reverse(); // V2.5: Show all events
                let html = `<h3 style="margin-bottom: 12px;">üìú Event History (${log.length} events)</h3>`;
                html += '<div style="max-height: 400px; overflow-y: auto; font-size: 0.85rem; line-height: 1.6;">';
                if (allEvents.length === 0) {
                    html += '<p style="color: var(--text-secondary);">No events yet.</p>';
                } else {
                    allEvents.forEach(e => {
                        html += `<p style="margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 8px;"><strong>Month ${e.month}:</strong> ${e.text.replace(/\n/g, '<br>')}</p>`;
                    });
                }
                html += '</div><button class="modal-btn primary" onclick="game.hideHistory()" style="margin-top: 16px;">Close</button>';
                document.getElementById('history-modal-content').innerHTML = html;
                document.getElementById('history-modal').classList.add('active');
            },

            hideHistory() {
                document.getElementById('history-modal').classList.remove('active');
            },

            // V2.9: Copy game link with seed
            copyGameLink() {
                const baseUrl = window.location.origin + window.location.pathname;
                const gameLink = `${baseUrl}?seed=${this.seed}`;
                navigator.clipboard.writeText(gameLink).then(() => {
                    alert('Game link copied!\n\n' + gameLink);
                }).catch(err => {
                    // Fallback for older browsers
                    prompt('Copy this link:', gameLink);
                });
            },

            // Advance month
            advanceMonth() {
                this.state.month++;
                this.state.totalMonths++;

                // V2.15: Earn coursework credits during Spring/Fall semesters
                const currentMonth = this.state.month;
                const isSemester = (currentMonth >= 1 && currentMonth <= 5) || (currentMonth >= 8 && currentMonth <= 12); // Spring or Fall
                const canEarnCredits = isSemester && !this.state.isTeaching && !this.state.onMedicalLeave;
                if (canEarnCredits) {
                    this.state.credits = (this.state.credits || 0) + 3;
                }

                if (this.state.month > 12) {
                    this.state.month = 1;
                    this.state.year++;
                    this.state.conferencesThisYear = 0; // V1.8: Reset conference count
                    this.state.vacationsThisYear = 0;  // V2.7: Reset vacation count
                    this.state.inspirationsThisYear = 0; // V2.8: Reset inspiration count
                    this.state.internshipThisYear = false; // V2.14: Reset internship
                    if (this.state.year === 2) {
                        this.removeStatus('firstYear');
                    }
                }

                // Monthly morale decay - V2.4: Alignment reduces decay
                let decay = 4;
                if (this.hasStatus('exhaustion')) decay += 6;
                if (this.hasStatus('unhappyAdvisor')) decay += 6;
                if (this.hasStatus('burnout')) decay += 2; // V2.4: Burnout penalty
                // V2.4: Strategic alignment reduces decay (1 point per 10 alignment - V2.18 update)
                // V2.5: TA duty also causes morale decay
                if (this.state.isTeaching) decay += 3;
                const alignmentBonus = Math.floor((this.state.strategicAlignment || 0) / 10);
                if (alignmentBonus > 0) {
                    this.appendMessage(`üõ°Ô∏è Advisor alignment protects you. (-${alignmentBonus} decay)`);
                }
                decay = Math.max(1, decay - alignmentBonus);
                // V2.11: New Lease on Life reduces decay by 50%
                if (this.state.newLeaseUntil && this.state.totalMonths < this.state.newLeaseUntil) {
                    decay = Math.ceil(decay / 2);
                }
                // V2.12: Light at the End of the Tunnel - 50% decay reduction with 3 journal papers
                if ((this.getItem('paper') || 0) >= 3) {
                    decay = Math.ceil(decay / 2);
                }
                this.state.morale = Math.max(0, this.state.morale - decay);
                // V2.11: Track low morale months for escalating MS-Out
                if (this.state.morale < 15) {
                    this.state.lowMoraleMonths = (this.state.lowMoraleMonths || 0) + 1;
                } else {
                    this.state.lowMoraleMonths = 0;
                }
                // V2.19: Telemetry - track months spent in low morale
                if (this.state.morale < 30) {
                    this.state.telemetry.moraleLowMonths++;
                }
                // V2.4: Respect maxMorale cap (reduced by burnout)
                const maxMorale = this.state.maxMorale || 100;
                this.state.morale = Math.min(maxMorale, this.state.morale);

                // V2.6: Advisor happiness level effects
                const advScore = this.state.advisorScore;
                if (advScore < 20 && !this.hasStatus('unhappyAdvisor')) {
                    this.addStatus('unhappyAdvisor');
                    this.appendMessage('üò† Your advisor is very unhappy with your progress! (+6 morale decay)');
                } else if (advScore >= 30 && this.hasStatus('unhappyAdvisor')) {
                    this.removeStatus('unhappyAdvisor');
                    this.appendMessage('üòä Your advisor seems satisfied with your recent efforts.');
                }
                // V2.6: Advisor mood warnings
                if (advScore < 40 && advScore >= 20 && this.random() < 0.1) {
                    this.appendMessage('üßë‚Äçüè´ Your advisor seems impatient lately. Consider showing progress.');
                }
                // V2.7: Serious morale warnings before death
                if (this.state.morale <= 10 && this.state.morale > 5) {
                    this.appendMessage('‚ö†Ô∏è CRITICAL: Your mental health is severely compromised. You feel disconnected from everything.');
                } else if (this.state.morale <= 5 && this.state.morale > 0) {
                    this.appendMessage('üö® EMERGENCY: You can barely function. One more setback and you\'re done.');
                }

                // V2.11: Escalating MS-Out warnings based on lowMoraleMonths
                const lowMonths = this.state.lowMoraleMonths || 0;
                if (lowMonths === 3) {
                    this.appendMessage('üßë‚Äçüè´ Your advisor gently asks: "Are you doing okay? Maybe we should talk about your options."');
                } else if (lowMonths === 6) {
                    this.appendMessage('üßë‚Äçüè´ Your advisor is concerned: "I think we need to seriously discuss the Master\'s option."');
                } else if (lowMonths === 9) {
                    this.appendMessage('‚ö†Ô∏è Your advisor insists: "The Master\'s exit may be your best remaining option. Think about it."');
                }

                // Check morale death - V2.11: Dignified MS-Out if has papers
                if (this.state.morale <= 0) {
                    const totalPubs = (this.getItem('paper') || 0) + (this.state.confPaperCount || 0);
                    if (totalPubs >= 1) {
                        // Dignified exit instead of failure
                        this.endGame(true, 'ms_out', 'You couldn\'t continue, but you earned a Master\'s degree with your ' + totalPubs + ' publication(s).');
                    } else {
                        this.endGame(false, 'morale', 'You ran out of morale and dropped out.');
                    }
                    return;
                }

                // V2.7: Advisor suggests vacation at critical morale (V2.18: patience limit 3)
                const interventions = this.state.advisorInterventions || 0;
                const patienceLimit = 3; // V2.18: Aspirational standard
                if (this.state.morale < 25 && !this.state.vacationOffered && !this.state.onVacation && interventions < patienceLimit) {
                    this.state.vacationOffered = true;
                    this.state.advisorInterventions = interventions + 1;
                    if (interventions >= patienceLimit - 1) {
                        this.appendMessage('üßë‚Äçüè´ Your advisor sighs: "This is the last time I can suggest this. Take some time off."');
                    } else {
                        this.appendMessage('üßë‚Äçüè´ Your advisor notices you\'re struggling:\n"You look exhausted. Why don\'t you take a week off? I insist."');
                    }
                } else if (interventions >= patienceLimit && !this.state.advisorPatienceExhausted) {
                    // V2.18: Advisor patience exhausted - stop offering rescues
                    this.state.advisorPatienceExhausted = true;
                    this.appendMessage('üòî Your advisor sighs: "I\'ve tried to help you, but you need to want it yourself." (No more forced rest offers)');
                } else if (this.state.advisorPatienceExhausted && this.state.morale < 20 && this.random() < 0.1) {
                    this.appendMessage('üßë‚Äçüè´ Your advisor has stopped checking on you. You\'re on your own now.');
                }

                // V2.4: Early MS-Out in Year 1 if morale critical (<15)
                if (this.state.year === 1 && this.state.morale < 15 && !this.state.msOutOffered) {
                    this.state.msOutOffered = true;
                    this.appendMessage('üíî Your advisor takes you aside: "This isn\'t working out. Maybe consider a Master\'s exit?"');
                }

                // V1.8: Process pending papers
                const s = this.state;
                if (s.pendingPapers && s.pendingPapers.length > 0) {
                    for (let i = s.pendingPapers.length - 1; i >= 0; i--) {
                        const paper = s.pendingPapers[i];
                        const wait = s.totalMonths - paper.submitted;
                        const isRevision = paper.type === 'revision';
                        const minWait = isRevision ? 2 : 3;  // Minimum 2-3 months
                        const maxWait = isRevision ? 4 : 6;  // Maximum 4-6 months

                        // Only check after minimum wait time
                        if (wait >= minWait) {
                            // Guaranteed result at max wait, 30% chance per month after min
                            if (wait >= maxWait || this.random() < 0.3) {
                                s.pendingPapers.splice(i, 1);
                                const acceptRate = isRevision ? 0.7 : 0.5; // V3.0: Adjusted
                                const roll = this.random();
                                if (roll < acceptRate) {
                                    this.addItem('paper');
                                    s.advisorScore = Math.min(100, s.advisorScore + 15);
                                    s.morale = Math.min(100, s.morale + 10);
                                    this.appendMessage('üéâ ACCEPTED! Paper published! (+10 morale)');
                                } else if (roll < acceptRate + 0.25 && !isRevision) {
                                    // V2.4: Expanded Reviewer #2 snark library
                                    this.addItem('rejected_paper');
                                    const reviewer2Msgs = [
                                        'üìù MAJOR REVISION. Reviewer #2 demands more experiments...',
                                        'üìù MAJOR REVISION. "The novelty is unclear..."',
                                        'üìù MAJOR REVISION. "Please address 47 minor comments..."',
                                        'üìù MAJOR REVISION. "The author\'s grasp of statistics is... novel."',
                                        'üìù MAJOR REVISION. "I stopped reading at Figure 2."',
                                        'üìù MAJOR REVISION. "This work is incremental at best."',
                                        'üìù MAJOR REVISION. "Have the authors read ANY related work?"',
                                        'üìù MAJOR REVISION. "The writing quality is unacceptable."',
                                        'üìù MAJOR REVISION. "I am not convinced this is publishable."'
                                    ];
                                    this.appendMessage(reviewer2Msgs[Math.floor(this.random() * reviewer2Msgs.length)]);
                                } else {
                                    this.addItem('rejected_paper');
                                    this.appendMessage('üò¢ REJECTED. The reviewers were not convinced. You can revise and resubmit.');
                                }
                            }
                        }
                    }
                }

                // Equipment repair - requires minimum 2 months
                if (this.hasStatus('brokenEquipment')) {
                    this.state.equipmentBrokenMonths++;
                    // Minimum 2 months, then 40% chance, guaranteed at 4 months
                    if (this.state.equipmentBrokenMonths >= 2) {
                        if (this.state.equipmentBrokenMonths >= 4 || this.random() < 0.4) {
                            this.removeStatus('brokenEquipment');
                            this.state.equipmentBrokenMonths = 0;
                            this.appendMessage('üîß Good news! The equipment has been fixed.');
                        }
                    }
                }

                // Random recovery events
                if (this.hasStatus('exhaustion') && this.random() < 0.12) {
                    this.removeStatus('exhaustion');
                    this.appendMessage('üíÜ You feel refreshed! Exhaustion has faded.');
                }
                if (this.hasStatus('unhappyAdvisor') && this.random() < 0.15) {
                    this.removeStatus('unhappyAdvisor');
                    this.appendMessage('ü§ù Your advisor seems to have forgiven you.');
                }

                // V2.9: Quals countdown warnings
                if (!this.state.qualsPassed && this.state.year <= 2) {
                    if (this.state.year === 1 && this.state.month === 9) {
                        this.appendMessage('‚ö†Ô∏è QUALS APPROACHING: Your qualifying exam is in 12 months (September Year 2). Start preparing!');
                    } else if (this.state.year === 2 && this.state.month === 7) {
                        this.appendMessage('‚è≥ QUALS IN 2 MONTHS: Prep level = ' + (this.state.qualifyLevel || 0) + '. You need 3 to pass!');
                    } else if (this.state.year === 2 && this.state.month === 8) {
                        this.appendMessage('üö® QUALS NEXT MONTH! Prep level = ' + (this.state.qualifyLevel || 0) + '. CRITICAL - prepare now!');
                    }
                }

                // Qualifying exam in September Year 2
                if (this.state.year === 2 && this.state.month === 9 && !this.state.qualsPassed && !this.state.qualsFailedOnce) {
                    this.triggerQuals();
                }

                // V2.9: Quals retake trigger (3 months after first failure)
                if (this.state.qualsDelayMonth && this.state.totalMonths >= this.state.qualsDelayMonth && !this.state.qualsPassed) {
                    this.appendMessage('üö® QUALS RETAKE TIME! This is your last chance!');
                    this.triggerQuals();
                    this.state.qualsDelayMonth = null; // Clear so it doesn't repeat
                }

                // V2.8: Random inspiration (capped at 2/year, diminishing returns)
                const inspirations = this.state.inspirationsThisYear || 0;
                if (this.random() < 0.03 && inspirations < 2) {
                    this.state.inspirationsThisYear = inspirations + 1;
                    this.state.telemetry.inspirationCount++; // V2.19: Track for balance
                    const inspireMorale = inspirations === 0 ? 15 : 10; // Diminishing
                    this.state.morale = Math.min(100, this.state.morale + inspireMorale);
                    this.addItem('idea');
                    this.appendRandomEvent(`üí° A sudden flash of inspiration strikes! (+${inspireMorale} morale, +1 idea)`);
                    // 20% dead end follow-up
                    if (inspirations > 0 && this.random() < 0.2) {
                        this.appendRandomEvent('üí≠ ...but on reflection, this might be a dead end.');
                    }
                }

                // V3.0: Imposter Syndrome (~8% chance)
                // V2.12: Soft cap - reduced impact after 2 events in 6 months
                if (this.random() < 0.08) {
                    const recentImposter = this.state.lastImposterMonths || [];
                    // Clean old entries (> 6 months ago)
                    const currentRecentImposter = recentImposter.filter(m => this.state.totalMonths - m < 6);

                    if (currentRecentImposter.length >= 2) {
                        // Soft cap: reduced impact
                        const reducedLoss = 1 + Math.floor(this.random() * 2); // 1-2 only
                        this.state.morale = Math.max(0, this.state.morale - reducedLoss);
                        this.state.strategicAlignment = (this.state.strategicAlignment || 0) + 2; // Self-awareness
                        this.appendRandomEvent('üßò You recognize this feeling again. It passes faster this time. (-' + reducedLoss + ' morale, +2 alignment)');
                    } else {
                        const imposterMsgs = [
                            'üò∞ You wonder if you really belong here...',
                            'üòî Everyone else seems so much smarter than you...',
                            'üòì Did they make a mistake admitting you?',
                            'ü•∫ Your labmate just published - why can\'t you?'
                        ];
                        const loss = 3 + Math.floor(this.random() * 5); // 3-7
                        this.state.morale = Math.max(0, this.state.morale - loss);
                        this.appendRandomEvent(imposterMsgs[Math.floor(this.random() * imposterMsgs.length)] + ' (-' + loss + ' morale)');
                        currentRecentImposter.push(this.state.totalMonths);
                    }
                    this.state.lastImposterMonths = currentRecentImposter;
                }

                // V2.11: Scoop event (24-month cooldown, V2.17: blocked if pre-registered)
                const lastScoop = this.state.lastScoopMonth || 0;
                const scoopCooldownOk = (this.state.totalMonths - lastScoop) >= 24;
                const isProtected = this.state.ideaPreRegistered;
                if (this.getItem('idea') > 0 && this.random() < 0.03 && scoopCooldownOk && !isProtected) {
                    this.removeItem('idea');
                    this.state.lastScoopMonth = this.state.totalMonths;
                    this.state.telemetry.scoopCount++; // V2.19: Track for balance
                    const scoopLoss = 5 + Math.floor(this.random() * 5);
                    this.state.morale = Math.max(0, this.state.morale - scoopLoss);
                    this.appendRandomEvent('üì¢ Another lab just published YOUR idea! (-1 idea, -' + scoopLoss + ' morale)');
                } else if (this.getItem('idea') > 0 && this.random() < 0.03 && scoopCooldownOk && isProtected) {
                    this.appendMessage('üìÑ Another lab tried to scoop you, but your pre-registration protects you!');
                }

                // V3.0: Seasonal Events
                const month = this.state.month;
                if (month === 12) { // December holidays
                    if (this.random() < 0.5) {
                        this.appendRandomEvent('üéÑ Holiday break! Time to rest. (+5 morale)');
                        this.state.morale = Math.min(100, this.state.morale + 5);
                    }
                } else if (month >= 6 && month <= 8) { // Summer
                    if (this.random() < 0.15) {
                        this.appendRandomEvent('‚òÄÔ∏è Summer focus! Fewer distractions. (+3 morale)');
                        this.state.morale = Math.min(100, this.state.morale + 3);
                    }
                } else if (month === 9) { // September - new semester chaos
                    if (this.random() < 0.3) {
                        this.appendRandomEvent('üìö New semester chaos! So many meetings... (-3 morale)');
                        this.state.morale = Math.max(0, this.state.morale - 3);
                    }
                }

                // V2.5: Teaching Duty aligned with semesters
                // Spring: Jan-May (months 1-5), Fall: Sep-Dec (months 9-12), Summer: Jun-Aug (rare)
                const isSemesterStart = (month === 1 || month === 6 || month === 9);
                const isSummer = (month === 6);
                const taChance = isSummer ? 0.03 : 0.1; // 3% summer, 10% fall/spring

                if (!this.state.isTeaching && isSemesterStart && this.random() < taChance) {
                    this.state.isTeaching = true;
                    // Duration based on semester
                    if (month === 1) {
                        this.state.teachingMonths = 5; // Spring: Jan-May
                        this.appendMessage('üìù You\'ve been assigned to TA for Spring semester! (Jan-May)');
                    } else if (month === 6) {
                        this.state.teachingMonths = 3; // Summer: Jun-Aug
                        this.appendMessage('üìù You\'ve been assigned to TA for Summer session! (Jun-Aug)');
                    } else {
                        this.state.teachingMonths = 4; // Fall: Sep-Dec
                        this.appendMessage('üìù You\'ve been assigned to TA for Fall semester! (Sep-Dec)');
                    }
                    this.addStatus('teaching'); // V2.5: Add as status effect
                }
                if (this.state.isTeaching) {
                    this.state.teachingMonths--;
                    if (this.state.teachingMonths <= 0) {
                        this.state.isTeaching = false;
                        this.removeStatus('teaching');
                        const teachBonus = 5 + Math.floor(this.random() * 5);
                        this.state.morale = Math.min(100, this.state.morale + teachBonus);
                        this.state.peerNetwork = Math.min(100, (this.state.peerNetwork || 0) + 5); // V2.5: +network
                        this.appendMessage('üéì TA duty complete! Students appreciated you. (+' + teachBonus + ' morale, +5 network)');
                    }
                }

                // V2.2 Pro: Process pending conference papers (4 month review)
                if (s.pendingConference && s.pendingConference.length > 0) {
                    for (let i = s.pendingConference.length - 1; i >= 0; i--) {
                        const conf = s.pendingConference[i];
                        const wait = s.totalMonths - conf.submitted;
                        if (wait >= 4) {
                            s.pendingConference.splice(i, 1);
                            // V2.5: Network boosts acceptance (60% base + alignment + network bonus)
                            const networkBonus = (s.peerNetwork || 0) * 0.002; // +0.2% per network point
                            const confAccept = 0.6 + (s.strategicAlignment * 0.002) + networkBonus;
                            if (this.random() < confAccept) {
                                s.confPaperCount = (s.confPaperCount || 0) + 1; // V2.5: Track count
                                s.peerNetwork = Math.min(100, s.peerNetwork + 15);
                                s.morale = Math.min(100, s.morale + 8);
                                this.appendMessage('üìã CONFERENCE ACCEPTED! (+15 network, +8 morale)');
                            } else {
                                this.addItem('rejected_paper'); // Can revise for journal
                                this.appendMessage('üìã Conference rejected. Consider revising for journal submission.');
                            }
                        }
                    }
                }

                // V2.8: MS-Out trigger (morale < 20, year >= 2, not already offered)
                // But if ‚â•2 papers published, give pep talk instead (late MS-Out is odd)
                const totalPubs = (this.getItem('paper') || 0) + (s.confPaperCount || 0);
                if (s.morale < 20 && s.year >= 2 && !s.msOutOffered) {
                    s.msOutOffered = true;
                    if (totalPubs >= 2) {
                        // V2.8: Pep talk instead of MS-Out for productive students
                        const pepGain = 15 + Math.floor(this.random() * 6);
                        s.morale = Math.min(100, s.morale + pepGain);
                        this.appendMessage('üßë‚Äçüè´ Your advisor gives you a pep talk: "You\'ve published well. Keep pushing - you\'re almost there." (+' + pepGain + ' morale)');
                    } else {
                        this.appendMessage('ü§î Your advisor notices your struggle. "Have you considered the Master\'s exit?"');
                    }
                }

                // V2.21: Accumulate stress based on actions and status
                if (this.hasStatus('exhaustion')) {
                    this.state.stress = Math.min(120, (this.state.stress || 0) + 5);
                }
                if (s.morale < 30) {
                    this.state.stress = Math.min(120, (this.state.stress || 0) + 3);
                }

                // V2.21: Check for support interventions
                this.checkPeerIntervention();
                this.checkAdvisorIntervention();

                // V2.19: Update game mode based on current state
                this.updateGameMode();

                this.updateUI();
            },

            // Trigger qualifying exam
            triggerQuals() {
                let msg = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nüìù QUALIFYING EXAM TIME! üìù\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';

                // V2.3: Study Group buff (network >= 50 counts as +1 prep)
                const hasStudyGroup = (this.state.peerNetwork || 0) >= 50;
                const effectiveLevel = this.state.qualifyLevel + (hasStudyGroup ? 1 : 0);

                if (effectiveLevel >= 3) {
                    if (hasStudyGroup && this.state.qualifyLevel < 2) {
                        msg += '‚úÖ Your study group helped you pass!';
                    } else {
                        msg += effectiveLevel >= 4 ? '‚úÖ Your thorough preparation paid off!' : '‚úÖ You passed the qualifying exam!';
                    }
                    this.state.morale = Math.min(100, this.state.morale + (effectiveLevel >= 4 ? 25 : 15));
                    this.state.qualsPassed = true;

                    // V2.11: "New Lease on Life" buff after successful retake
                    if (this.state.qualsFailedOnce) {
                        this.state.newLeaseUntil = this.state.totalMonths + 6;
                        msg += '\n\nüåü NEW LEASE ON LIFE! üåü\nMorale decay reduced for 6 months.';
                    }
                } else {
                    // V2.9: Soft fail option (once)
                    if (!this.state.qualsFailedOnce) {
                        this.state.qualsFailedOnce = true;
                        this.state.morale = Math.max(0, this.state.morale - 25);
                        this.addStatus('exhaustion');
                        this.state.qualsDelayMonth = this.state.totalMonths + 3; // Retry in 3 months
                        msg += '‚ùå QUALS FAILED ‚ùå\n';
                        msg += 'Your committee is giving you ONE more chance.\n';
                        msg += 'You have 3 months to prepare for the retake.\n';
                        msg += '(-25 morale, +Exhaustion)';
                    } else {
                        msg += '‚ùå QUALS FAILED AGAIN ‚ùå\nYou needed prep level 3 to pass.';
                        this.showMessage(msg);
                        this.endGame(false, 'quals_failed', 'You were dismissed after failing quals twice.');
                        return;
                    }
                }

                this.showMessage(msg);
            },

            // End game
            endGame(won, reason, message) {
                this.state.isRunning = false;
                this.state.isEnded = true;
                this.state.endState = { won, reason, message };

                // V2.18: Resolve career ending
                const exitType = (reason === 'graduation' || reason === 'defense') ? 'PhD' :
                    (reason === 'ms_out') ? 'MS' : null;
                const career = exitType ? this.resolveCareerEnding(exitType) : null;

                // Store in telemetry
                if (this.state.telemetry) {
                    this.state.telemetry.endReason = reason;
                }

                document.getElementById('game-screen').style.display = 'none';
                document.getElementById('end-screen').style.display = 'block';
                document.getElementById('end-screen').className = `end-screen panel ${won ? 'won' : 'lost'}`;

                // V2.18: Different messages with career endings
                let title, endMessage;
                if (reason === 'ms_out' && career) {
                    title = `üéì Master's Degree Earned! üéì`;
                    endMessage = `${career.emoji} Your Career: ${career.name}\n\n${career.desc}`;
                } else if (won && career) {
                    title = 'üéìüéâ Congratulations, Doctor! üéâüéì';
                    endMessage = `${career.emoji} Your Career: ${career.name}\n\n${career.desc}`;
                } else if (won) {
                    title = 'üéìüéâ Congratulations, Doctor! üéâüéì';
                    endMessage = 'You have defended your thesis and earned your PhD!';
                } else {
                    title = 'üíî Game Over üíî';
                    endMessage = message;
                }

                document.getElementById('end-title').textContent = title;
                document.getElementById('end-message').innerHTML = endMessage.replace(/\n/g, '<br>');
                // V2.7: Include more stats, history, and seed access on end screen
                const journalPapers = this.getItem('paper') || 0;
                const confPapers = this.state.confPaperCount || 0;
                document.getElementById('end-stats').innerHTML = `
                <p style="color: var(--text-secondary); margin-bottom: 12px;">
                    Months elapsed: ${this.state.totalMonths}<br>
                    Publications: ${journalPapers + confPapers} (${journalPapers} Journal + ${confPapers} Conference)<br>
                    Final morale: ${this.state.morale}%<br>
                    Peer Network: ${this.state.peerNetwork || 0}<br>
                    Strategic Alignment: ${this.state.strategicAlignment || 0}<br>
                    Advisor Happiness: ${this.state.advisorScore}%
                </p>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">
                    Seed: ${this.seed}
                </p>
                <button class="modal-btn" onclick="game.showHistory()" style="margin-right: 8px;">üìú View History</button>
                <button class="modal-btn" onclick="game.copyGameLink()">üîó Copy Game Link</button>
            `;
            },

            // Get available actions
            getActions() {
                const s = this.state;
                const actions = [];

                // V2.20: Block actions when waiting for event acknowledgement
                if (this.waitingForAcknowledge) {
                    actions.push({ id: 'waiting', name: '‚è≥ Read Event', desc: 'Click "Continue" to proceed', disabled: true });
                    return actions;
                }

                // Always available
                actions.push({ id: 'read', name: 'üìö Read Papers', desc: 'Search for ideas', telemetry: 'research' });

                if (this.getItem('idea') > 0) {
                    actions.push({ id: 'work_idea', name: 'üí° Work on Idea', desc: 'Develop preliminary results', telemetry: 'research' });
                }
                if (this.getItem('initial_findings') > 0) {
                    actions.push({ id: 'work_findings', name: 'üî¨ Develop Findings', desc: 'Work toward Key Discovery', telemetry: 'research' });
                }
                if (this.getItem('key_discovery') > 0) {
                    const figures = this.getItem('figure') || 0;
                    if (this.hasStatus('brokenEquipment')) {
                        actions.push({ id: 'work_figures_blocked', name: 'üìä Validate Discovery', desc: '‚ö†Ô∏è BLOCKED - Equipment!', disabled: true });
                    } else {
                        actions.push({ id: 'work_figures', name: 'üìä Validate Discovery', desc: `Figures: ${figures}/3` });
                    }
                }
                if (this.getItem('rejected_paper') > 0) {
                    actions.push({ id: 'revise', name: '‚úèÔ∏è Revise Paper', desc: 'Revise and resubmit' });
                }
                // V2.5: Thesis requires 3 "journal equivalents" (2 conf papers = 1 journal)
                const journalPapers = this.getItem('paper') || 0;
                const confPapers = s.confPaperCount || 0;
                const journalEquivalent = journalPapers + Math.floor(confPapers / 2);

                // V2.18: Defense Prep Gate - lock actions when ready to graduate
                if (journalEquivalent >= 3 && !s.defensePrepared) {
                    // Only finale actions available
                    return [
                        { id: 'prepare_defense', name: 'üéì Prepare Defense', desc: 'Organize your thesis chapters' },
                        { id: 'polish_thesis', name: '‚ú® Polish Thesis', desc: 'Final revisions (+5 morale)' },
                        { id: 'break', name: '‚òï Take a Break', desc: 'Rest before the big day' }
                    ];
                }

                if (journalEquivalent >= 3 && s.defensePrepared) {
                    actions.push({ id: 'thesis', name: 'üéì Defend Thesis!', desc: `Ready! (${journalPapers}J + ${confPapers}C)` });
                }
                // V1.8: Show pending papers
                if (s.pendingPapers && s.pendingPapers.length > 0) {
                    actions.push({ id: 'pending', name: '‚è≥ Pending Papers', desc: s.pendingPapers.length + ' under review', disabled: true });
                }

                actions.push({ id: 'break', name: '‚òï Take a Break', desc: 'Rest and recover', telemetry: 'mental_health' });

                // V2.10: Medical Leave (emergency escape, one-time use)
                if (s.morale < 15 && !s.medicalLeaveUsed) {
                    actions.push({ id: 'medical_leave', name: 'üè• Medical Leave', desc: 'Emergency: +40 morale, costs 3-6 months', telemetry: 'mental_health' });
                }

                // V2.5: Advisor-suggested vacation (fast recovery, optional)
                if (s.vacationOffered && !s.onVacation) {
                    actions.push({ id: 'vacation', name: 'üèñÔ∏è Take Time Off', desc: 'Advisor suggested rest', telemetry: 'mental_health' });
                }

                // V2.2 Pro: Pitch Session (always available after first year)
                if (s.statuses && s.statuses.has && !s.statuses.has('firstYear')) {
                    actions.push({ id: 'pitch', name: 'üí¨ Pitch Session', desc: 'Get advisor feedback on ideas', telemetry: 'admin' });
                }

                // V2.8: Conference limited - Year 1-2: max 1, Year 3+: max 2
                const maxConf = s.year <= 2 ? 1 : 2;
                const confLeft = maxConf - (s.conferencesThisYear || 0);
                actions.push({
                    id: confLeft > 0 ? 'conference' : 'conference_disabled',
                    name: 'üé§ Conference',
                    desc: `(${confLeft}/${maxConf} remaining for this yr)`,
                    disabled: confLeft <= 0
                });

                // V2.2 Pro: Conference paper submission (if has figures but want quick publish)
                if (this.getItem('key_discovery') > 0 && this.getItem('figure') >= 3) {
                    actions.push({ id: 'conf_paper', name: 'üìã Conference Paper', desc: 'Quick publish (4mo, +network)' });
                    actions.push({ id: 'write_paper', name: 'üìù Journal Paper', desc: 'Submit for review (8-12mo)' });
                }

                // V2.2 Pro: Show pending conference papers
                if (s.pendingConference && s.pendingConference.length > 0) {
                    actions.push({ id: 'pending_conf', name: 'üìã Pending Conf', desc: s.pendingConference.length + ' under review', disabled: true });
                }

                // V2.3: Qual prep with urgency warnings and Study Group
                // V2.10: Also show during retake period
                const needsQualPrep = !s.qualsPassed && (
                    (s.year === 1) ||
                    (s.year === 2 && s.month < 9) ||
                    (s.qualsFailedOnce && s.qualsDelayMonth) // Retake period
                );
                if (needsQualPrep) {
                    const preps = s.qualifyLevel || 0;
                    const needed = 3 - preps;

                    // Study Group: High network counts as 1 prep
                    const hasStudyGroup = (s.peerNetwork || 0) >= 50;
                    const effectiveNeeded = hasStudyGroup && preps < 3 ? Math.max(0, needed - 1) : needed;

                    let qualsDesc = 'Study for exam';
                    let qualsName = 'üìñ Prep for Quals';

                    // V2.9: Retake urgency
                    if (s.qualsFailedOnce && s.qualsDelayMonth) {
                        const monthsToRetake = s.qualsDelayMonth - s.totalMonths;
                        if (monthsToRetake > 0) {
                            qualsName = 'üÜò RETAKE PREP';
                            qualsDesc = `${monthsToRetake}mo until retake! Level: ${preps}/3`;
                        }
                    }
                    // V2.3: Urgency warnings for first attempt
                    else if (s.year === 2 && effectiveNeeded > 0) {
                        const monthsLeft = 9 - s.month;
                        if (monthsLeft <= 3 && monthsLeft > 0) {
                            qualsName = '‚ö†Ô∏èüìñ URGENT: Quals Prep';
                            qualsDesc = `${monthsLeft}mo left! Need ${effectiveNeeded} more session${effectiveNeeded > 1 ? 's' : ''}`;
                        }
                    } else if (preps > 0) {
                        qualsDesc = `Progress: ${preps}/3 sessions`;
                    }
                    if (hasStudyGroup && preps < 3) {
                        qualsDesc += ' (+1 from Study Group)';
                    }

                    actions.push({ id: 'quals', name: qualsName, desc: qualsDesc });

                    // V2.3: Last-Minute Cram in August Y2
                    if (s.year === 2 && s.month === 8 && effectiveNeeded > 0) {
                        actions.push({
                            id: 'cram',
                            name: 'üÜò Last-Minute Cram',
                            desc: 'Emergency! Pass quals but -25 morale'
                        });
                    }
                }

                // V2.15: MS-Out option (requires 30 credits + 18 months)
                const hasEnoughCredits = (s.credits || 0) >= 30;
                const hasEnoughTime = s.totalMonths >= 18;
                if (s.msOutOffered && s.morale < 30 && hasEnoughCredits && hasEnoughTime) {
                    actions.push({ id: 'ms_out', name: 'üö™ Master\'s Exit', desc: 'Leave with MS degree' });
                } else if (s.msOutOffered && s.morale < 30) {
                    const missing = [];
                    if (!hasEnoughCredits) missing.push((30 - (s.credits || 0)) + ' credits');
                    if (!hasEnoughTime) missing.push((18 - s.totalMonths) + ' months');
                    actions.push({ id: 'ms_out_blocked', name: 'üö™ Master\'s Exit', desc: 'Need: ' + missing.join(', '), disabled: true });
                }

                // V2.15: Summer Internship (June-July only, once per year, after Year 1)
                const isTrueSummer = s.month >= 6 && s.month <= 7;
                if (isTrueSummer && s.year >= 2 && !s.internshipThisYear) {
                    actions.push({ id: 'internship', name: 'üíº Summer Internship', desc: '3 months: +25 network, +15 morale' });
                }

                // V2.17: Pre-Register Idea (prevents scoop)
                if (this.getItem('idea') > 0 && !s.ideaPreRegistered && (s.peerNetwork || 10) >= 5) {
                    const cost = (s.peerNetwork || 10) >= 60 ? 3 : 5;
                    actions.push({ id: 'preregister', name: 'üìÑ Pre-Register Idea', desc: `-${cost} network, prevents scoop` });
                }

                // V2.17: Equipment Maintenance (prevents failure)
                if (!s.equipmentStableUntil || s.totalMonths >= s.equipmentStableUntil) {
                    actions.push({ id: 'maintenance', name: 'üîß Equipment Maintenance', desc: 'Skip research, stable 12mo' });
                }

                // V2.17: High-Throughput Experiment (risky fast figures)
                if (this.getItem('key_discovery') > 0 && (!s.lastHighThroughput || s.totalMonths - s.lastHighThroughput >= 6)) {
                    actions.push({ id: 'high_throughput', name: '‚ö° High-Throughput Exp', desc: '40%: +2 figures, fail: -morale +exhaustion' });
                }

                // V2.17: Respond to Reviewers (during journal review)
                if (s.pendingPapers && s.pendingPapers.length > 0) {
                    actions.push({ id: 'light_response', name: 'üìù Light Response', desc: '-3 morale, +10% accept' });
                    actions.push({ id: 'major_rebuttal', name: 'üß† Major Rebuttal', desc: '-8 morale, skip revision' });
                }

                actions.push({ id: 'advance', name: '‚è© Next Month', desc: 'Skip to next month' });

                return actions;
            },

            // Perform action
            doAction(id) {
                if (this.state.isEnded) return;

                let msg = '';
                const s = this.state;

                switch (id) {
                    case 'read':
                        // V2.6: Reading papers now gives small bonuses
                        const readSuccess = [
                            'üí° A paper sparked a new research idea!',
                            'üí° Interesting! You see a gap in the literature...',
                            'üí° This could lead somewhere - new idea gained!'
                        ];
                        const readFail = [
                            'üìö You read papers and gained perspective. (+2 alignment)',
                            'üìö Productive reading session. (+2 network)',
                            'üìö Deep literature review - you feel more prepared.'
                        ];
                        if (this.random() < 0.4) {
                            this.addItem('idea');
                            msg = this.pick(readSuccess);
                        } else {
                            // V2.6: Give small bonuses even when no idea
                            if (this.random() < 0.5) {
                                s.strategicAlignment = (s.strategicAlignment || 0) + 2;
                                msg = 'üìö You read papers and gained perspective. (+2 alignment)';
                            } else {
                                s.peerNetwork = Math.min(100, (s.peerNetwork || 0) + 2);
                                msg = 'üìö Productive reading session. You noted some collaborators. (+2 network)';
                            }
                        }
                        if (this.random() < 0.05) {
                            this.addStatus('exhaustion');
                            msg += '\nüò´ All that reading has left you exhausted...';
                        }
                        break;

                    case 'work_idea':
                        const ideaSuccess = [
                            'üéâ Initial Findings achieved! (+5 morale)',
                            'üéâ The experiment worked - Initial Findings! (+5 morale)',
                            'üéâ Promising results documented! (+5 morale)'
                        ];
                        // V2.5: Advisor feedback on ideas
                        const ideaFail = [
                            'üßë‚Äçüè´ Advisor: "This approach needs more thought..."',
                            'üßë‚Äçüè´ Advisor: "Inconclusive. Try a different angle."',
                            'üßë‚Äçüè´ Advisor: "Not quite what I had in mind..."'
                        ];
                        if (this.random() < 0.45) {
                            this.removeItem('idea');
                            this.addItem('initial_findings');
                            s.morale = Math.min(100, s.morale + 5);
                            msg = 'üßë‚Äçüè´ Advisor: "This is promising! Keep going." (+5 morale)\n' + this.pick(ideaSuccess);
                        } else {
                            msg = this.pick(ideaFail);
                        }
                        break;

                    case 'work_findings':
                        // V2.5: Advisor feedback on findings
                        const findSuccess = [
                            'üßë‚Äçüè´ Advisor: "Excellent work! This is publishable." (+5 morale)',
                            'üßë‚Äçüè´ Advisor: "Great results! Write this up." (+5 morale)',
                            'üßë‚Äçüè´ Advisor: "Solid discovery! I\'m impressed." (+5 morale)'
                        ];
                        const findFail = [
                            'üßë‚Äçüè´ Advisor: "The findings aren\'t strong enough yet..."',
                            'üßë‚Äçüè´ Advisor: "More controls needed. Redo the experiment."',
                            'üßë‚Äçüè´ Advisor: "Reviewers would tear this apart..."'
                        ];
                        // V2.12: Renewed Perspective bonus (+10%)
                        const perspectiveBonus = (s.renewedPerspectiveUntil && s.totalMonths < s.renewedPerspectiveUntil) ? 0.1 : 0;
                        if (this.random() < (0.35 + perspectiveBonus)) {
                            this.removeItem('initial_findings');
                            this.addItem('key_discovery');
                            s.morale = Math.min(100, s.morale + 5);
                            msg = this.pick(findSuccess);
                            if (perspectiveBonus > 0) msg += '\n‚ú® Renewed perspective helped!';
                        } else {
                            msg = this.pick(findFail);
                        }
                        break;

                    case 'work_figures':
                        // V2.10: Figure decompression - after 2 consecutive rejections, +30% success
                        const figRejections = s.consecutiveFigRejections || 0;
                        const figBonus = figRejections >= 2 ? 0.3 : 0;
                        // V2.12: Renewed Perspective bonus (+10%)
                        const figPerspective = (s.renewedPerspectiveUntil && s.totalMonths < s.renewedPerspectiveUntil) ? 0.1 : 0;
                        if (this.random() < (0.6 + figBonus + figPerspective)) {
                            this.addItem('figure');
                            s.morale = Math.min(100, s.morale + 3);
                            s.consecutiveFigRejections = 0; // Reset on success
                            if (figRejections >= 2) {
                                msg = 'üìä You\'re finally seeing what reviewers want! Figure created! (' + this.getItem('figure') + '/3 needed) (+3 morale)';
                            } else {
                                msg = 'üìä Figure created! (' + this.getItem('figure') + '/3 needed) (+3 morale)';
                            }
                        } else {
                            s.consecutiveFigRejections = figRejections + 1;
                            const figFail = [
                                'üòî The visualization isn\'t clear enough...',
                                'üòî Reviewer 2 would hate this figure.',
                                'üòî The data doesn\'t look right plotted this way.'
                            ];
                            msg = this.pick(figFail);
                            if (s.consecutiveFigRejections >= 2) {
                                msg += '\nüí° You\'re learning what works. Next attempt will be easier.';
                            }
                        }
                        if (this.random() < 0.05) {
                            this.addStatus('brokenEquipment');
                            msg += '\n‚ö†Ô∏è Your equipment just broke down!';
                        }
                        break;

                    case 'write_paper':
                        this.removeItem('key_discovery');
                        // V2.1: Clear ALL figures (can't reuse for next paper)
                        delete this.state.items['figure'];
                        // V1.8: Paper goes to pending review
                        s.pendingPapers.push({ submitted: s.totalMonths, type: 'new' });
                        msg = 'üìÆ Paper submitted! Now we wait for the reviewers...';
                        break;

                    case 'revise':
                        this.removeItem('rejected_paper');
                        // V1.8: Revision goes to pending
                        s.pendingPapers.push({ submitted: s.totalMonths, type: 'revision' });
                        msg = 'üìÆ Revision submitted! Fingers crossed...';
                        break;

                    case 'break':
                        const gain = 5 + Math.floor(this.random() * 10);
                        s.morale = Math.min(100, s.morale + gain);
                        s.advisorScore = Math.max(0, s.advisorScore - 3);
                        msg = this.getMessage('break') + ' (+' + gain + ' morale)';
                        if (this.hasStatus('exhaustion') && this.random() < 0.4) {
                            this.removeStatus('exhaustion');
                            msg += '\nüíÜ You feel refreshed!';
                        }
                        if (this.hasStatus('unhappyAdvisor') && this.random() < 0.25) {
                            this.removeStatus('unhappyAdvisor');
                            msg += '\nü§ù Your advisor has cooled down.';
                        }
                        break;

                    // V2.10: Medical Leave (emergency escape, one-time use)
                    case 'medical_leave':
                        const leaveDuration = 3 + Math.floor(this.random() * 4); // 3-6 months
                        s.medicalLeaveUsed = true;
                        s.morale = Math.min(100, s.morale + 40);
                        if (this.hasStatus('exhaustion')) this.removeStatus('exhaustion');
                        if (this.hasStatus('burnout')) this.removeStatus('burnout');
                        // Reset current project (lose progress)
                        this.state.items['idea'] = 0;
                        this.state.items['initial_findings'] = 0;
                        this.state.items['key_discovery'] = 0;
                        this.state.items['figure'] = 0;
                        // Advance time
                        for (let i = 0; i < leaveDuration; i++) {
                            s.month++;
                            s.totalMonths++;
                            if (s.month > 12) { s.month = 1; s.year++; }
                        }
                        msg = 'üè• You took medical leave for ' + leaveDuration + ' months.\n';
                        msg += 'You feel much better. (+40 morale, cleared exhaustion)\n';
                        msg += '‚ö†Ô∏è Your current project was reset. Time to start fresh.';
                        break;

                    // V2.7: Advisor-suggested vacation with diminishing returns
                    case 'vacation':
                        const vacationsThisYear = s.vacationsThisYear || 0;
                        // Base gain 15-25, reduced by 5 for each prior vacation
                        const baseVacGain = 15 + Math.floor(this.random() * 11);
                        const vacGain = Math.max(5, baseVacGain - (vacationsThisYear * 5));
                        s.morale = Math.min(s.maxMorale || 100, s.morale + vacGain);
                        s.vacationOffered = false; // Used up the offer
                        s.lastVacationMonth = s.totalMonths;
                        s.vacationsThisYear = vacationsThisYear + 1;
                        if (this.hasStatus('exhaustion')) this.removeStatus('exhaustion');
                        if (vacationsThisYear === 0 && this.hasStatus('burnout')) this.removeStatus('burnout');
                        // V2.12: Renewed Perspective buff after advisor-forced vacation
                        s.renewedPerspectiveUntil = s.totalMonths + 3;
                        if (vacationsThisYear >= 2) {
                            msg = 'üèñÔ∏è Another break... diminishing returns. (+' + vacGain + ' morale)';
                        } else {
                            msg = 'üèñÔ∏è You took time off as your advisor suggested.\nYou feel refreshed! (+' + vacGain + ' morale)\n\n‚ú® Renewed Perspective: +10% success for 3 months!';
                        }
                        break;

                    case 'conference':
                        s.conferencesThisYear = (s.conferencesThisYear || 0) + 1;

                        // V2.8: Early conferences (Year 1-2) have 20% "Alienating" chance
                        if (s.year <= 2 && this.random() < 0.2) {
                            s.morale = Math.max(0, s.morale - 3);
                            msg = 'üé§ Conference was alienating... You felt out of place. (-3 morale)';
                            break;
                        }

                        // V2.7: Diminishing morale returns when network > 80
                        let confMorale = 2 + Math.floor(this.random() * 3); // 2-4
                        if ((s.peerNetwork || 0) > 80) confMorale = Math.ceil(confMorale / 2);
                        s.morale = Math.min(100, s.morale + confMorale);
                        // V2.7: Network gain diminishes at high levels
                        const netGain = (s.peerNetwork || 0) > 80 ? 2 : 5;
                        s.peerNetwork = Math.min(100, (s.peerNetwork || 0) + netGain);
                        msg = 'üé§ You attended a conference! (+' + confMorale + ' morale, +' + netGain + ' network)';
                        if (this.random() < 0.35) {
                            this.addItem('idea');
                            msg += '\nüí° The talks inspired a new idea!';
                        }
                        if (this.random() < 0.1) {
                            s.advisorScore = Math.min(100, s.advisorScore + 10);
                            msg += '\nü§ù Your advisor heard good things!';
                        }
                        break;

                    case 'quals':
                        const points = Math.floor(this.random() * 3);
                        s.qualifyLevel += points;
                        if (points === 0) {
                            msg = 'üìñ You studied but didn\'t retain much...';
                        } else if (points === 1) {
                            msg = 'üìñ Decent study session!';
                        } else {
                            msg = 'üìñ Great progress on exam prep!';
                        }
                        break;

                    // V2.4: Last-Minute Cram with Burnout Penalty
                    case 'cram':
                        s.qualifyLevel = Math.max(s.qualifyLevel, 2); // Guarantee pass
                        s.morale = Math.max(0, s.morale - 25);
                        // V2.4: Permanent penalty - reduce max morale
                        s.maxMorale = (s.maxMorale || 100) - 10;
                        this.addStatus('exhaustion');
                        this.addStatus('burnout'); // V2.4: New status
                        msg = 'üÜò EMERGENCY CRAM SESSION!\nYou passed, but the toll on your mind is permanent. (-25 morale, max morale reduced)';
                        break;

                    // V2.18: Defense Prep Gate actions
                    case 'prepare_defense':
                        s.defensePrepared = true;
                        s.morale = Math.min(100, s.morale + 10);
                        msg = 'üìù You organize your thesis chapters and prepare your defense slides.\n\n+10 morale from the sense of accomplishment.\n\nüéì You can now defend your thesis!';
                        break;

                    case 'polish_thesis':
                        s.morale = Math.min(100, s.morale + 5);
                        msg = '‚ú® You polish your thesis, fixing typos and improving figures.\n\n+5 morale from the satisfaction of good work.';
                        break;

                    case 'thesis':
                        document.getElementById('thesis-modal').classList.add('active');
                        return; // Don't advance month yet

                    case 'advance':
                        msg = 'Time passes...';
                        break;

                    // V2.2 Pro: Pitch Session
                    case 'pitch':
                        const adv = s.advisor;
                        const pitchMsgs = [];
                        if (adv.riskTolerance > 55) {
                            pitchMsgs.push('üí¨ "I like bold ideas - what\'s your craziest hypothesis?"');
                            s.strategicAlignment += 2;
                        } else if (adv.riskTolerance < 45) {
                            pitchMsgs.push('üí¨ "Let\'s stick to proven methods for now..."');
                        }
                        if (adv.strictness > 55) {
                            pitchMsgs.push('üí¨ "Every comma matters. Polish before showing me."');
                        } else if (adv.strictness < 45) {
                            pitchMsgs.push('üí¨ "Don\'t worry about perfection, show me progress!"');
                        }
                        if (adv.attentionSpan > 55) {
                            pitchMsgs.push('üí¨ "Send it over, I\'ll review tonight."');
                        } else if (adv.attentionSpan < 45) {
                            pitchMsgs.push('üí¨ "I\'ll get to it when I can... busy month."');
                        }
                        msg = pitchMsgs.length > 0 ? this.pick(pitchMsgs) : 'üí¨ Your advisor nods thoughtfully.';
                        s.peerNetwork = Math.min(100, s.peerNetwork + 3);
                        msg += '\n+3 peer network (learned advisor style)';
                        break;

                    // V2.2 Pro: Conference Paper (quick publish track)
                    case 'conf_paper':
                        this.removeItem('key_discovery');
                        delete this.state.items['figure'];
                        s.pendingConference.push({ submitted: s.totalMonths });
                        msg = 'üìã Conference paper submitted! (4 month review)';
                        break;

                    // V2.13: MS-Out with timing-based exit profiles
                    case 'ms_out':
                        let exitProfile, exitTitle, exitNarrative;
                        const yearsElapsed = s.year;
                        const totalPubs = (this.getItem('paper') || 0) + (s.confPaperCount || 0);

                        if (yearsElapsed <= 2) {
                            exitTitle = 'üöÄ The Early Career Pivot';
                            exitNarrative = 'You recognized early that academia wasn\'t for you. Smart move.';
                            exitProfile = s.peerNetwork > 40 ? 'Tech Startup Founder' : 'Industry Associate';
                        } else if (yearsElapsed <= 4) {
                            exitTitle = 'üîß Deep Technical Specialist';
                            exitNarrative = 'Your years of focused research made you a domain expert.';
                            exitProfile = totalPubs >= 2 ? 'Senior Data Scientist' : 'R&D Engineer';
                        } else {
                            exitTitle = 'üéñÔ∏è Veteran Problem-Solver';
                            exitNarrative = 'Your persistence and resilience are your greatest assets.';
                            exitProfile = s.peerNetwork > 70 ? 'Industry R&D Lead' : 'Principal Engineer';
                        }

                        const salaryBonus = yearsElapsed > 4 ? '+15% salary boost' : yearsElapsed > 2 ? '+10% salary boost' : '';
                        this.endGame(true, 'ms_out', `${exitTitle}\n\n${exitNarrative}\n\nYou left with a Master's degree as: ${exitProfile}\n${salaryBonus}`);
                        return;

                    // V2.13: Summer Internship (3 months, big network/morale boost)
                    case 'internship':
                        s.internshipThisYear = true;
                        s.peerNetwork = Math.min(100, (s.peerNetwork || 10) + 25);
                        s.morale = Math.min(100, s.morale + 15);
                        s.advisorScore = Math.max(0, s.advisorScore - 5);
                        // Advance 3 months
                        for (let i = 0; i < 3; i++) {
                            s.month++;
                            s.totalMonths++;
                            if (s.month > 12) { s.month = 1; s.year++; s.internshipThisYear = false; }
                        }
                        msg = 'üíº You completed a summer internship!\n+25 Peer Network, +15 morale\nüßë‚Äçüè´ Advisor: "I hope you gained some useful experience..." (-5 advisor)';
                        break;

                    // V2.17: Pre-Register Idea
                    case 'preregister':
                        const preregCost = (s.peerNetwork || 10) >= 60 ? 3 : 5;
                        s.peerNetwork = Math.max(0, (s.peerNetwork || 10) - preregCost);
                        s.ideaPreRegistered = true;
                        msg = `üìÑ Pre-registered your idea!\n-${preregCost} Network\n‚úÖ Protected from being scooped`;
                        break;

                    // V2.17: Equipment Maintenance
                    case 'maintenance':
                        s.equipmentStableUntil = s.totalMonths + 12;
                        this.removeStatus('brokenEquipment');
                        msg = 'üîß Equipment Maintenance Complete!\nEquipment stable for 12 months\n(No research this month)';
                        break;

                    // V2.17: High-Throughput Experiment
                    case 'high_throughput':
                        s.lastHighThroughput = s.totalMonths;
                        s.morale = Math.max(0, s.morale - 10); // 2x normal cost
                        if (this.random() < 0.4) {
                            s.figuresReady = (s.figuresReady || 0) + 2;
                            msg = '‚ö° HIGH-THROUGHPUT SUCCESS!\n+2 Figures ready\nYou pushed hard and it paid off!';
                        } else {
                            this.addStatus('exhaustion');
                            s.morale = Math.max(0, s.morale - 10);
                            msg = '‚ö° High-Throughput FAILED!\n+Exhaustion, -20 morale total\nThe experiment didn\'t produce usable data.';
                        }
                        break;

                    // V2.17: Light Response to Reviewers
                    case 'light_response':
                        s.morale = Math.max(0, s.morale - 3);
                        if (s.pendingPapers && s.pendingPapers.length > 0) {
                            s.pendingPapers[0].bonusChance = (s.pendingPapers[0].bonusChance || 0) + 0.10;
                        }
                        msg = 'üìù Sent light response to reviewers\n-3 morale\n+10% acceptance chance';
                        break;

                    // V2.17: Major Rebuttal
                    case 'major_rebuttal':
                        s.morale = Math.max(0, s.morale - 8);
                        if (s.pendingPapers && s.pendingPapers.length > 0) {
                            s.pendingPapers[0].skipRevision = true;
                        }
                        msg = 'üß† Major Rebuttal submitted!\n-8 morale\nWill skip "Major Revision" if any';
                        break;
                }

                this.showMessage(msg);
                this.advanceMonth();
            },

            // Thesis actions
            thesisDefend() {
                document.getElementById('thesis-modal').classList.remove('active');
                if (this.random() < 0.9) {
                    this.showMessage('üéìüéâ CONGRATULATIONS, DOCTOR! üéâüéì\n\nYou\'ve successfully defended your thesis!');
                } else {
                    this.showMessage('üòÖ The defense was rough, but you passed with major revisions!');
                }
                this.endGame(true, 'graduation', 'Congratulations, you have earned your PhD!');
            },

            // V1.7: Help modal
            showHelp() {
                document.getElementById('help-modal').classList.add('active');
            },

            hideHelp() {
                document.getElementById('help-modal').classList.remove('active');
            },

            // V2.0.1: Show seed info
            showSeed() {
                const seed = this.seed || 'random';
                const url = window.location.origin + window.location.pathname + '?seed=' + seed;
                alert('Current Seed: ' + seed + '\n\nShare this URL:\n' + url);
            },

            thesisStay() {
                document.getElementById('thesis-modal').classList.remove('active');
                this.state.morale = Math.min(100, this.state.morale + 20);
                this.state.advisorScore = Math.min(100, this.state.advisorScore + 10);
                this.showMessage('You decide to stay and do more research. Your advisor is pleased. (+20 morale)');
                this.advanceMonth();
            },

            // Update UI - V2.19: Uses toUIState() transformer
            updateUI() {
                const ui = this.toUIState();
                const s = this.state; // Still needed for items/statuses

                // Stats (from UIState)
                this.dom.date.textContent = ui.dateText;
                this.dom.totalMonths.textContent = ui.totalMonths;
                this.dom.semester.textContent = ui.semester;
                this.dom.credits.textContent = ui.credits;

                // Publications (from UIState)
                this.dom.papers.textContent = ui.totalPubs;
                this.dom.pubBreakdown.textContent = ui.pubBreakdown;

                // Pending reviews (from UIState)
                let reviewLines = [];
                if (ui.pendingJournal > 0) reviewLines.push(`üìù ${ui.pendingJournal} Journal in review`);
                if (ui.pendingConf > 0) reviewLines.push(`üìã ${ui.pendingConf} Conf in review`);
                this.dom.reviewStatus.innerHTML = reviewLines.join('<br>');

                // Peer Network & Alignment (from UIState)
                this.dom.peerNetwork.textContent = ui.network;
                this.dom.alignmentValue.textContent = ui.alignment;
                this.dom.alignmentBar.style.width = `${Math.min(100, ui.alignment)}%`;

                // Quals Prep visualizer (from UIState)
                if (ui.qualsVisible) {
                    this.dom.qualsCard.style.display = 'block';
                    this.dom.qualsValue.textContent = ui.qualsLevel;
                    this.dom.qualsCard.style.borderColor = ui.qualsWarning.border;
                    this.dom.qualsWarning.innerHTML = ui.qualsWarning.text;
                    this.dom.qualsWarning.style.color = ui.qualsWarning.color;
                } else if (ui.qualsPassed) {
                    this.dom.qualsCard.style.display = 'none';
                }

                // Morale (from UIState helper methods)
                this.dom.moraleBar.style.width = `${ui.morale}%`;
                this.dom.moraleStatus.textContent = ui.moraleText;
                this.dom.moraleBar.className = 'progress-fill ' + ui.moraleClass;

                // Advisor (from UIState helper methods)
                this.dom.advisorBar.style.width = `${ui.advisorScore}%`;
                this.dom.advisorStatus.textContent = ui.advisorText;
                this.dom.advisorBar.className = 'progress-fill ' + ui.advisorClass;

                // Actions
                try {
                    const actions = this.getActions();
                    this.dom.actions.innerHTML = actions.map(a => `
                    <button class="action-btn${a.disabled ? ' disabled' : ''}" ${a.disabled ? '' : `onclick="game.doAction('${a.id}')"`}>
                        <div class="action-name">${a.name}</div>
                        <div class="action-desc">${a.desc}</div>
                    </button>
                `).join('');
                } catch (e) {
                    console.error('Error in getActions:', e);
                    this.dom.actions.innerHTML = '<div style="color: red;">Error loading actions. Check console.</div>';
                }

                // V2.0: Pipeline Visualizer
                const stages = [
                    { icon: 'üìö', label: 'Ideas', count: this.getItem('idea') },
                    { icon: '‚Üí', label: '' },
                    { icon: 'üî¨', label: 'Findings', count: this.getItem('initial_findings') },
                    { icon: '‚Üí', label: '' },
                    { icon: 'üéØ', label: 'Discovery', count: this.getItem('key_discovery') },
                    { icon: '‚Üí', label: '' },
                    { icon: 'üìä', label: 'Figures', count: this.getItem('figure') }
                ];

                this.dom.pipeline.innerHTML = stages.map(st => {
                    if (st.label === '') return `<span style="color: var(--text-secondary);">${st.icon}</span>`;
                    const hasItems = st.count > 0;
                    const style = hasItems
                        ? 'background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 4px 10px; border-radius: 12px;'
                        : 'color: var(--text-secondary);';
                    return `<span style="${style}">${st.icon} ${st.label}${hasItems ? ' √ó' + st.count : ''}</span>`;
                }).join('');

                // Pending/Rejected/TA (review status moved to Publications panel in V2.14)
                const extras = [];
                if (this.getItem('rejected_paper') > 0) extras.push('‚ùå Rejected √ó' + this.getItem('rejected_paper'));
                if (s.isTeaching) extras.push('üìù TA Duty (' + s.teachingMonths + ' mo)');
                if (extras.length > 0) {
                    this.dom.pipeline.innerHTML += '<br><span style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">' + extras.join(' | ') + '</span>';
                }

                // Statuses
                const statusNames = { exhaustion: 'Exhaustion', unhappyAdvisor: 'Unhappy Advisor', brokenEquipment: 'Broken Equipment', firstYear: 'First Year' };
                const negatives = ['exhaustion', 'unhappyAdvisor', 'brokenEquipment'];
                let statusHTML = '';

                // V2.12: Add special buff badges
                if (s.renewedPerspectiveUntil && s.totalMonths < s.renewedPerspectiveUntil) {
                    const monthsLeft = s.renewedPerspectiveUntil - s.totalMonths;
                    statusHTML += `<span class="status-badge positive">‚ú® Renewed Focus (${monthsLeft}mo)</span>`;
                }
                if (s.newLeaseUntil && s.totalMonths < s.newLeaseUntil) {
                    const monthsLeft = s.newLeaseUntil - s.totalMonths;
                    statusHTML += `<span class="status-badge positive">üåü New Lease (${monthsLeft}mo)</span>`;
                }
                // V2.12: Light at the End of the Tunnel (3 journal papers)
                const journalPapersCount = this.getItem('paper') || 0;
                if (journalPapersCount >= 3) {
                    statusHTML += `<span class="status-badge positive">üèÅ Almost There!</span>`;
                }

                if (s.statuses.size > 0) {
                    statusHTML += Array.from(s.statuses).map(id =>
                        `<span class="status-badge${negatives.includes(id) ? ' negative' : ''}">${statusNames[id] || id}</span>`
                    ).join('');
                }

                if (statusHTML) {
                    this.dom.statuses.innerHTML = statusHTML;
                } else {
                    this.dom.statuses.innerHTML = '<span class="empty-text">No effects</span>';
                }
            }
        };

        // Check for saved game on load
        document.addEventListener('DOMContentLoaded', () => game.checkSave());
    </script>

    <!-- GoatCounter Analytics -->
    <script data-goatcounter="https://wangxiangyu.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>