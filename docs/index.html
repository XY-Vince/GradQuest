<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ GradQuest - PhD Life Simulator</title>
    <meta name="description"
        content="A text-based PhD life simulator game. Can you publish papers and graduate before running out of morale?">
    <meta name="author" content="XY-Vince">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-success: #22c55e;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1a2e 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .progress-bar {
            background: var(--bg-card);
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s;
        }

        .progress-fill.high {
            background: linear-gradient(90deg, #22c55e, #4ade80);
        }

        .progress-fill.medium {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .progress-fill.low {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .event-panel {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid var(--accent-primary);
            margin-bottom: 20px;
        }

        .event-panel h3 {
            color: var(--accent-primary);
            margin-bottom: 12px;
        }

        .message-log {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 16px;
            min-height: 80px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        @media (max-width: 800px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
        }

        .panel h3 {
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
        }

        .action-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            color: var(--text-primary);
        }

        .action-btn:hover {
            background: var(--accent-primary);
            transform: translateY(-2px);
        }

        .action-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn.disabled:hover {
            background: var(--bg-card);
            transform: none;
        }

        .action-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .action-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .action-btn:hover .action-desc {
            color: rgba(255, 255, 255, 0.8);
        }

        .badge-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .item-badge {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .status-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .status-badge.negative {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
        }

        .empty-text {
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.85rem;
        }

        .start-screen,
        .end-screen {
            text-align: center;
            padding: 60px 20px;
        }

        .start-btn {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 14px;
            padding: 16px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }

        .start-btn.secondary {
            background: var(--bg-card);
        }

        .end-screen.won {
            background: linear-gradient(180deg, rgba(34, 197, 94, 0.1) 0%, transparent 100%);
        }

        .end-screen.lost {
            background: linear-gradient(180deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 28px;
            max-width: 450px;
            width: 90%;
            text-align: center;
        }

        .modal h2 {
            margin-bottom: 12px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 0.95rem;
        }

        .modal-btn.primary {
            background: var(--accent-success);
            color: white;
        }

        .modal-btn.secondary {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .save-btn {
            width: 100%;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ“ GradQuest</h1>
        </header>

        <div id="app">
            <!-- Start Screen -->
            <div id="start-screen" class="start-screen panel">
                <h2 style="margin-bottom: 16px;">Welcome to GradQuest!</h2>
                <p
                    style="color: var(--text-secondary); margin-bottom: 30px; max-width: 500px; margin: 0 auto 30px; font-size: 0.95rem;">
                    Survive the PhD journey: publish 3 papers, defend your thesis,<br>
                    and keep your morale above zero!
                </p>
                <button class="start-btn" onclick="game.start()">ğŸš€ Start PhD Journey</button>
                <button class="start-btn secondary" id="load-btn" onclick="game.load()" style="display: none;">ğŸ’¾ Load
                    Game</button>
                <button class="start-btn secondary" onclick="game.showHelp()">Help</button>
            </div>

            <!-- Game Screen -->
            <div id="game-screen" style="display: none;">
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-label">ğŸ“… Date</div>
                        <div class="stat-value" id="date">Sep, Year 1</div>
                        <div style="color: var(--text-secondary); font-size: 0.8rem;">Month <span
                                id="total-months">1</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ğŸ’ª Morale</div>
                        <div class="stat-value" style="font-size: 1.2rem;" id="morale-status">ğŸ˜Š Good</div>
                        <div class="progress-bar">
                            <div class="progress-fill high" id="morale-bar" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ğŸ‘¨â€ğŸ« Advisor</div>
                        <div class="stat-value" style="font-size: 1.2rem;" id="advisor-status">ğŸ™‚ Happy</div>
                        <div class="progress-bar">
                            <div class="progress-fill high" id="advisor-bar" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ğŸ“° Papers</div>
                        <div class="stat-value"><span id="papers">0</span></div>
                    </div>
                    <!-- V2.2 Pro: Peer Network -->
                    <div class="stat-card">
                        <div class="stat-label">ğŸ¤ Network</div>
                        <div class="stat-value"><span id="peer-network">10</span></div>
                    </div>
                </div>

                <!-- V2.4: Dual event display for current and previous month -->
                <div class="event-panel" style="display: flex; gap: 12px;">
                    <div style="flex: 1;">
                        <h3 style="font-size: 0.9rem; margin-bottom: 8px;">ğŸ“¢ This Month</h3>
                        <div class="message-log" id="message-log" style="min-height: 80px;">Your PhD journey begins...
                        </div>
                    </div>
                    <div style="flex: 1; opacity: 0.7;">
                        <h3 style="font-size: 0.9rem; margin-bottom: 8px;">ğŸ“œ Last Month</h3>
                        <div class="message-log" id="message-log-prev" style="min-height: 80px; font-size: 0.85rem;">-
                        </div>
                    </div>
                </div>

                <div class="main-content">
                    <div class="panel">
                        <h3>ğŸ“‹ Actions</h3>
                        <div class="actions-grid" id="actions"></div>
                    </div>

                    <div>
                        <div class="panel">
                            <h3>ğŸ”¬ Research Pipeline</h3>
                            <div id="pipeline"
                                style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; font-size: 0.85rem;">
                                <!-- Pipeline steps rendered by JS -->
                            </div>
                        </div>
                        <div class="panel">
                            <h3>âš¡ Status Effects</h3>
                            <div class="badge-list" id="statuses"><span class="empty-text">No effects</span></div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="action-btn save-btn" onclick="game.save()" style="flex: 1;">
                                <div class="action-name">ğŸ’¾ Save</div>
                            </button>
                            <button class="action-btn save-btn" onclick="game.loadFromSave()" style="flex: 1;">
                                <div class="action-name">ğŸ“‚ Load</div>
                            </button>
                        </div>
                        <!-- V2.0.1: Footer buttons -->
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button class="action-btn save-btn" onclick="game.showHelp()"
                                style="flex: 1; padding: 6px;">
                                <div class="action-name" style="font-size: 0.85rem;">â“ Help</div>
                            </button>
                            <button class="action-btn save-btn" onclick="game.showSeed()"
                                style="flex: 1; padding: 6px;">
                                <div class="action-name" style="font-size: 0.85rem;">ğŸ² Seed</div>
                            </button>
                            <button class="action-btn save-btn" onclick="game.showHistory()"
                                style="flex: 1; padding: 6px;">
                                <div class="action-name" style="font-size: 0.85rem;">ğŸ“œ History</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- End Screen -->
            <div id="end-screen" class="end-screen panel" style="display: none;">
                <div id="end-title" style="font-size: 1.8rem; margin-bottom: 16px;">ğŸ“ Congratulations!</div>
                <div id="end-message" style="color: var(--text-secondary); margin-bottom: 20px;"></div>
                <div id="end-stats" style="margin-bottom: 30px;"></div>
                <button class="start-btn" onclick="game.restart()">ğŸ”„ Play Again</button>
            </div>
        </div>
    </div>

    <!-- Thesis Modal -->
    <div class="modal-overlay" id="thesis-modal">
        <div class="modal">
            <h2>ğŸ“š Thesis Time!</h2>
            <p>You have enough papers to graduate. What would you like to do?</p>
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="game.thesisDefend()">ğŸ“ Defend Thesis</button>
                <button class="modal-btn secondary" onclick="game.thesisStay()">ğŸ“– Stay for Research</button>
            </div>
        </div>
    </div>

    <!-- V2.2: History Modal -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal" style="max-width: 550px; text-align: left;">
            <div id="history-modal-content"></div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal" style="max-width: 600px; text-align: left; max-height: 85vh; overflow-y: auto;">
            <h2 style="text-align: center;">ğŸ“– How to Play</h2>
            <div style="margin-top: 16px; line-height: 1.7; font-size: 0.95rem;">
                <p><strong>ğŸ¯ Goal:</strong> Publish 3 journal papers and defend your thesis!</p>

                <p style="margin-top: 14px;"><strong>ğŸ“Š Research Pipeline:</strong></p>
                <p style="font-size: 0.9rem; color: var(--text-secondary);">
                    ğŸ“š Read â†’ ğŸ’¡ Idea â†’ ğŸ”¬ Findings â†’ ğŸ¯ Discovery â†’ ğŸ“Š Figures (Ã—3) â†’ ğŸ“ Paper
                </p>

                <p style="margin-top: 14px;"><strong>ğŸ“‹ Publication Tracks:</strong></p>
                <ul style="margin-left: 20px; font-size: 0.9rem;">
                    <li><strong>Journal Paper</strong>: 8-12 months, counts toward graduation</li>
                    <li><strong>Conference Paper</strong>: 4 months, builds network (+15)</li>
                </ul>

                <p style="margin-top: 14px;"><strong>ğŸ§‘â€ğŸ« Advisor System:</strong></p>
                <ul style="margin-left: 20px; font-size: 0.9rem;">
                    <li>Your advisor has hidden traits that affect outcomes</li>
                    <li>Use <strong>Pitch Session</strong> to learn their preferences</li>
                    <li>Signals: fast/slow response, harsh/encouraging tone</li>
                </ul>

                <p style="margin-top: 14px;"><strong>ğŸ¤ Peer Network:</strong></p>
                <ul style="margin-left: 20px; font-size: 0.9rem;">
                    <li>Build through conferences and pitch sessions</li>
                    <li>High network â†’ better endings and collaboration</li>
                </ul>

                <p style="margin-top: 14px;"><strong>ğŸšª Strategic Exits:</strong></p>
                <ul style="margin-left: 20px; font-size: 0.9rem;">
                    <li>If morale drops too low, Master's exit becomes available</li>
                    <li>Endings: R&D Lead / Data Scientist / Great Escape</li>
                </ul>

                <p style="margin-top: 14px;"><strong>âš ï¸ Key Events:</strong></p>
                <ul style="margin-left: 20px; font-size: 0.9rem;">
                    <li>Qual exam: September Year 2 (prepare 2+ times)</li>
                    <li>Imposter syndrome, getting scooped, teaching duty</li>
                    <li>Reviewer #2 may request major revisions</li>
                </ul>
            </div>
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="game.hideHelp()">Got it!</button>
            </div>
        </div>
    </div>

    <script>
        // GradQuest - Pure JavaScript Game Engine
        const game = {
            state: null,

            // Month names
            months: ["", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],

            // V1.7: Seed for reproducible randomness
            seed: null,
            seedState: null,

            // V1.7: Seeded random number generator
            random() {
                if (!this.seedState) {
                    this.seedState = this.seed || Math.floor(Math.random() * 999999);
                }
                this.seedState = (this.seedState * 1103515245 + 12345) & 0x7fffffff;
                return (this.seedState / 0x7fffffff);
            },

            // Initialize new game state
            initState() {
                return {
                    year: 1,
                    month: 9,
                    morale: 50,
                    advisorScore: 50,
                    qualifyLevel: 0,
                    qualsPassed: false,
                    items: {},
                    statuses: new Set(['firstYear']),
                    equipmentBrokenMonths: 0,
                    totalMonths: 1,
                    isRunning: true,
                    isEnded: false,
                    endState: null,
                    conferencesThisYear: 0,
                    pendingPapers: [],
                    // V2.1: Teaching duty
                    isTeaching: false,
                    teachingMonths: 0,
                    // V2.2 Pro: Advisor profiling
                    advisor: {
                        riskTolerance: 30 + Math.floor(Math.random() * 40),  // 30-70
                        attentionSpan: 30 + Math.floor(Math.random() * 40),  // 30-70
                        strictness: 30 + Math.floor(Math.random() * 40)       // 30-70
                    },
                    // V2.2 Pro: Peer network and strategic alignment
                    peerNetwork: 10,
                    strategicAlignment: 0,
                    // V2.2 Pro: Track pending by type
                    pendingConference: [],
                    confPaperCount: 0, // V2.5: Published conference papers
                    msOutOffered: false,
                    // V2.2: Event log for history
                    eventLog: []
                };
            },

            // V1.8: Pick random from array
            pick(arr) {
                return arr[Math.floor(this.random() * arr.length)];
            },

            // Random number generator
            random() {
                return Math.random();
            },

            // Start new game
            start() {
                // V1.7: Check for seed in URL
                const urlParams = new URLSearchParams(window.location.search);
                this.seed = urlParams.get('seed') ? parseInt(urlParams.get('seed')) : Math.floor(Math.random() * 999999);
                this.seedState = this.seed;

                this.state = this.initState();
                this.showMessage('ğŸ“ Welcome to your PhD program!\n\nYou start in September. Your goal: publish 3 papers and defend your thesis.');
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'block';
                this.updateUI();
            },

            // Restart game
            restart() {
                localStorage.removeItem('gradquest_save');
                document.getElementById('end-screen').style.display = 'none';
                this.start();
            },

            // Save game
            save() {
                const saveData = {
                    ...this.state,
                    statuses: Array.from(this.state.statuses),
                    version: '1.7'
                };
                localStorage.setItem('gradquest_save', JSON.stringify(saveData));
                alert('ğŸ’¾ Game saved!');
            },

            // Load game
            load() {
                const data = localStorage.getItem('gradquest_save');
                if (!data) {
                    alert('No saved game found!');
                    return;
                }
                const saveData = JSON.parse(data);
                this.state = {
                    ...saveData,
                    statuses: new Set(saveData.statuses)
                };
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'block';
                this.updateUI();
            },

            // Check for saved game on page load
            checkSave() {
                if (localStorage.getItem('gradquest_save')) {
                    document.getElementById('load-btn').style.display = 'inline-block';
                }
            },

            // Get item count
            getItem(id) {
                return this.state.items[id] || 0;
            },

            // Add item
            addItem(id, count = 1) {
                this.state.items[id] = (this.state.items[id] || 0) + count;
            },

            // Remove item
            removeItem(id, count = 1) {
                this.state.items[id] = Math.max(0, (this.state.items[id] || 0) - count);
                if (this.state.items[id] === 0) delete this.state.items[id];
            },

            // Check status
            hasStatus(id) {
                return this.state.statuses.has(id);
            },

            // Add status
            addStatus(id) {
                this.state.statuses.add(id);
            },

            // Remove status
            removeStatus(id) {
                this.state.statuses.delete(id);
            },

            // V1.9: Load game from within gameplay
            loadFromSave() {
                const data = localStorage.getItem('gradquest_save');
                if (!data) {
                    alert('No saved game found!');
                    return;
                }
                if (confirm('Load saved game? Current progress will be lost.')) {
                    const saveData = JSON.parse(data);
                    this.state = {
                        ...saveData,
                        statuses: new Set(saveData.statuses)
                    };
                    this.updateUI();
                    this.showMessage('ğŸ“‚ Game loaded!');
                }
            },

            // V2.4: Typewriter effect with dual display
            typeTimer: null,
            showMessage(msg) {
                const el = document.getElementById('message-log');
                const prevEl = document.getElementById('message-log-prev');
                if (this.typeTimer) clearInterval(this.typeTimer);

                // V2.4: Shift current to previous before displaying new
                if (prevEl && el.textContent && el.textContent !== 'Your PhD journey begins...') {
                    prevEl.textContent = el.textContent;
                }

                el.textContent = '';
                let i = 0;
                this.typeTimer = setInterval(() => {
                    el.textContent += msg[i++];
                    if (i >= msg.length) clearInterval(this.typeTimer);
                }, 15);
                // V2.2: Log to event history
                if (this.state && this.state.eventLog) {
                    this.state.eventLog.push({ month: this.state.totalMonths, text: msg });
                }
            },

            // Append message
            appendMessage(msg) {
                const el = document.getElementById('message-log');
                if (this.typeTimer) clearInterval(this.typeTimer);
                const current = el.textContent;
                const full = current + '\n' + msg;
                el.textContent = current + '\n';
                let i = 0;
                this.typeTimer = setInterval(() => {
                    el.textContent = current + '\n' + msg.slice(0, ++i);
                    if (i >= msg.length) clearInterval(this.typeTimer);
                }, 15);
                // V2.2: Log to event history
                if (this.state && this.state.eventLog) {
                    this.state.eventLog.push({ month: this.state.totalMonths, text: msg });
                }
            },

            // V2.5: Show full event history modal
            showHistory() {
                const log = this.state.eventLog || [];
                const allEvents = log.slice().reverse(); // V2.5: Show all events
                let html = `<h3 style="margin-bottom: 12px;">ğŸ“œ Event History (${log.length} events)</h3>`;
                html += '<div style="max-height: 400px; overflow-y: auto; font-size: 0.85rem; line-height: 1.6;">';
                if (allEvents.length === 0) {
                    html += '<p style="color: var(--text-secondary);">No events yet.</p>';
                } else {
                    allEvents.forEach(e => {
                        html += `<p style="margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 8px;"><strong>Month ${e.month}:</strong> ${e.text.replace(/\n/g, '<br>')}</p>`;
                    });
                }
                html += '</div><button class="modal-btn primary" onclick="game.hideHistory()" style="margin-top: 16px;">Close</button>';
                document.getElementById('history-modal-content').innerHTML = html;
                document.getElementById('history-modal').classList.add('active');
            },

            hideHistory() {
                document.getElementById('history-modal').classList.remove('active');
            },

            // Advance month
            advanceMonth() {
                this.state.month++;
                this.state.totalMonths++;

                if (this.state.month > 12) {
                    this.state.month = 1;
                    this.state.year++;
                    this.state.conferencesThisYear = 0; // V1.8: Reset conference count
                    if (this.state.year === 2) {
                        this.removeStatus('firstYear');
                    }
                }

                // Monthly morale decay - V2.4: Alignment reduces decay
                let decay = 4;
                if (this.hasStatus('exhaustion')) decay += 6;
                if (this.hasStatus('unhappyAdvisor')) decay += 6;
                if (this.hasStatus('burnout')) decay += 2; // V2.4: Burnout penalty
                // V2.4: Strategic alignment reduces decay (1 point per 25 alignment)
                // V2.5: TA duty also causes morale decay
                if (this.state.isTeaching) decay += 3;
                const alignmentReduce = Math.floor((this.state.strategicAlignment || 0) / 25);
                decay = Math.max(1, decay - alignmentReduce);
                this.state.morale = Math.max(0, this.state.morale - decay);
                // V2.4: Respect maxMorale cap (reduced by burnout)
                const maxMorale = this.state.maxMorale || 100;
                this.state.morale = Math.min(maxMorale, this.state.morale);

                // Check morale death
                if (this.state.morale <= 0) {
                    this.endGame(false, 'morale', 'You ran out of morale and dropped out.');
                    return;
                }

                // V2.5: Advisor suggests vacation at critical morale
                if (this.state.morale < 25 && !this.state.vacationOffered && !this.state.onVacation) {
                    this.state.vacationOffered = true;
                    this.appendMessage('ğŸ§‘â€ğŸ« Your advisor notices you\'re struggling:\n"You look exhausted. Why don\'t you take a week off? I insist."');
                }

                // V2.4: Early MS-Out in Year 1 if morale critical (<15)
                if (this.state.year === 1 && this.state.morale < 15 && !this.state.msOutOffered) {
                    this.state.msOutOffered = true;
                    this.appendMessage('ğŸ’” Your advisor takes you aside: "This isn\'t working out. Maybe consider a Master\'s exit?"');
                }

                // V1.8: Process pending papers
                const s = this.state;
                if (s.pendingPapers && s.pendingPapers.length > 0) {
                    for (let i = s.pendingPapers.length - 1; i >= 0; i--) {
                        const paper = s.pendingPapers[i];
                        const wait = s.totalMonths - paper.submitted;
                        const isRevision = paper.type === 'revision';
                        const minWait = isRevision ? 2 : 3;  // Minimum 2-3 months
                        const maxWait = isRevision ? 4 : 6;  // Maximum 4-6 months

                        // Only check after minimum wait time
                        if (wait >= minWait) {
                            // Guaranteed result at max wait, 30% chance per month after min
                            if (wait >= maxWait || this.random() < 0.3) {
                                s.pendingPapers.splice(i, 1);
                                const acceptRate = isRevision ? 0.7 : 0.5; // V3.0: Adjusted
                                const roll = this.random();
                                if (roll < acceptRate) {
                                    this.addItem('paper');
                                    s.advisorScore = Math.min(100, s.advisorScore + 15);
                                    s.morale = Math.min(100, s.morale + 10);
                                    this.appendMessage('ğŸ‰ ACCEPTED! Paper published! (+10 morale)');
                                } else if (roll < acceptRate + 0.25 && !isRevision) {
                                    // V2.4: Expanded Reviewer #2 snark library
                                    this.addItem('rejected_paper');
                                    const reviewer2Msgs = [
                                        'ğŸ“ MAJOR REVISION. Reviewer #2 demands more experiments...',
                                        'ğŸ“ MAJOR REVISION. "The novelty is unclear..."',
                                        'ğŸ“ MAJOR REVISION. "Please address 47 minor comments..."',
                                        'ğŸ“ MAJOR REVISION. "The author\'s grasp of statistics is... novel."',
                                        'ğŸ“ MAJOR REVISION. "I stopped reading at Figure 2."',
                                        'ğŸ“ MAJOR REVISION. "This work is incremental at best."',
                                        'ğŸ“ MAJOR REVISION. "Have the authors read ANY related work?"',
                                        'ğŸ“ MAJOR REVISION. "The writing quality is unacceptable."',
                                        'ğŸ“ MAJOR REVISION. "I am not convinced this is publishable."'
                                    ];
                                    this.appendMessage(reviewer2Msgs[Math.floor(this.random() * reviewer2Msgs.length)]);
                                } else {
                                    this.addItem('rejected_paper');
                                    this.appendMessage('ğŸ˜¢ REJECTED. The reviewers were not convinced. You can revise and resubmit.');
                                }
                            }
                        }
                    }
                }

                // Equipment repair - requires minimum 2 months
                if (this.hasStatus('brokenEquipment')) {
                    this.state.equipmentBrokenMonths++;
                    // Minimum 2 months, then 40% chance, guaranteed at 4 months
                    if (this.state.equipmentBrokenMonths >= 2) {
                        if (this.state.equipmentBrokenMonths >= 4 || this.random() < 0.4) {
                            this.removeStatus('brokenEquipment');
                            this.state.equipmentBrokenMonths = 0;
                            this.appendMessage('ğŸ”§ Good news! The equipment has been fixed.');
                        }
                    }
                }

                // Random recovery events
                if (this.hasStatus('exhaustion') && this.random() < 0.12) {
                    this.removeStatus('exhaustion');
                    this.appendMessage('ğŸ’† You feel refreshed! Exhaustion has faded.');
                }
                if (this.hasStatus('unhappyAdvisor') && this.random() < 0.15) {
                    this.removeStatus('unhappyAdvisor');
                    this.appendMessage('ğŸ¤ Your advisor seems to have forgiven you.');
                }

                // Qualifying exam in September Year 2
                if (this.state.year === 2 && this.state.month === 9 && !this.state.qualsPassed) {
                    this.triggerQuals();
                }

                // Random inspiration
                if (this.random() < 0.03) {
                    this.state.morale = Math.min(100, this.state.morale + 15);
                    this.addItem('idea');
                    this.appendMessage('ğŸ’¡ A sudden flash of inspiration strikes! (+15 morale, +1 idea)');
                }

                // V3.0: Imposter Syndrome (~8% chance)
                if (this.random() < 0.08) {
                    const imposterMsgs = [
                        'ğŸ˜° You wonder if you really belong here...',
                        'ğŸ˜” Everyone else seems so much smarter than you...',
                        'ğŸ˜“ Did they make a mistake admitting you?',
                        'ğŸ¥º Your labmate just published - why can\'t you?'
                    ];
                    const loss = 3 + Math.floor(this.random() * 5); // 3-7
                    this.state.morale = Math.max(0, this.state.morale - loss);
                    this.appendMessage(imposterMsgs[Math.floor(this.random() * imposterMsgs.length)] + ' (-' + loss + ' morale)');
                }

                // V3.0: Getting Scooped (~3% if you have ideas)
                if (this.getItem('idea') > 0 && this.random() < 0.03) {
                    this.removeItem('idea');
                    const scoopLoss = 5 + Math.floor(this.random() * 5);
                    this.state.morale = Math.max(0, this.state.morale - scoopLoss);
                    this.appendMessage('ğŸ“¢ Another lab just published YOUR idea! (-1 idea, -' + scoopLoss + ' morale)');
                }

                // V3.0: Seasonal Events
                const month = this.state.month;
                if (month === 12) { // December holidays
                    if (this.random() < 0.5) {
                        this.appendMessage('ğŸ„ Holiday break! Time to rest. (+5 morale)');
                        this.state.morale = Math.min(100, this.state.morale + 5);
                    }
                } else if (month >= 6 && month <= 8) { // Summer
                    if (this.random() < 0.15) {
                        this.appendMessage('â˜€ï¸ Summer focus! Fewer distractions. (+3 morale)');
                        this.state.morale = Math.min(100, this.state.morale + 3);
                    }
                } else if (month === 9) { // September - new semester chaos
                    if (this.random() < 0.3) {
                        this.appendMessage('ğŸ“š New semester chaos! So many meetings... (-3 morale)');
                        this.state.morale = Math.max(0, this.state.morale - 3);
                    }
                }

                // V2.5: Teaching Duty aligned with semesters
                // Spring: Jan-May (months 1-5), Fall: Sep-Dec (months 9-12), Summer: Jun-Aug (rare)
                const isSemesterStart = (month === 1 || month === 6 || month === 9);
                const isSummer = (month === 6);
                const taChance = isSummer ? 0.03 : 0.1; // 3% summer, 10% fall/spring

                if (!this.state.isTeaching && isSemesterStart && this.random() < taChance) {
                    this.state.isTeaching = true;
                    // Duration based on semester
                    if (month === 1) {
                        this.state.teachingMonths = 5; // Spring: Jan-May
                        this.appendMessage('ğŸ“ You\'ve been assigned to TA for Spring semester! (Jan-May)');
                    } else if (month === 6) {
                        this.state.teachingMonths = 3; // Summer: Jun-Aug
                        this.appendMessage('ğŸ“ You\'ve been assigned to TA for Summer session! (Jun-Aug)');
                    } else {
                        this.state.teachingMonths = 4; // Fall: Sep-Dec
                        this.appendMessage('ğŸ“ You\'ve been assigned to TA for Fall semester! (Sep-Dec)');
                    }
                    this.addStatus('teaching'); // V2.5: Add as status effect
                }
                if (this.state.isTeaching) {
                    this.state.teachingMonths--;
                    if (this.state.teachingMonths <= 0) {
                        this.state.isTeaching = false;
                        this.removeStatus('teaching');
                        const teachBonus = 5 + Math.floor(this.random() * 5);
                        this.state.morale = Math.min(100, this.state.morale + teachBonus);
                        this.state.peerNetwork = Math.min(100, (this.state.peerNetwork || 0) + 5); // V2.5: +network
                        this.appendMessage('ğŸ“ TA duty complete! Students appreciated you. (+' + teachBonus + ' morale, +5 network)');
                    }
                }

                // V2.2 Pro: Process pending conference papers (4 month review)
                if (s.pendingConference && s.pendingConference.length > 0) {
                    for (let i = s.pendingConference.length - 1; i >= 0; i--) {
                        const conf = s.pendingConference[i];
                        const wait = s.totalMonths - conf.submitted;
                        if (wait >= 4) {
                            s.pendingConference.splice(i, 1);
                            // V2.5: Network boosts acceptance (60% base + alignment + network bonus)
                            const networkBonus = (s.peerNetwork || 0) * 0.002; // +0.2% per network point
                            const confAccept = 0.6 + (s.strategicAlignment * 0.002) + networkBonus;
                            if (this.random() < confAccept) {
                                s.confPaperCount = (s.confPaperCount || 0) + 1; // V2.5: Track count
                                s.peerNetwork = Math.min(100, s.peerNetwork + 15);
                                s.morale = Math.min(100, s.morale + 8);
                                this.appendMessage(`ğŸ“‹ CONFERENCE ACCEPTED! (Total: ${s.confPaperCount}C, +15 network, +8 morale)`);
                            } else {
                                this.addItem('rejected_paper'); // Can revise for journal
                                this.appendMessage('ğŸ“‹ Conference rejected. Consider revising for journal submission.');
                            }
                        }
                    }
                }

                // V2.2 Pro: MS-Out trigger (morale < 20, year >= 2, not already offered)
                if (s.morale < 20 && s.year >= 2 && !s.msOutOffered) {
                    s.msOutOffered = true;
                    this.appendMessage('ğŸ¤” Your advisor notices your struggle. "Have you considered the Master\'s exit?"');
                }

                this.updateUI();
            },

            // Trigger qualifying exam
            triggerQuals() {
                let msg = 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“ QUALIFYING EXAM TIME! ğŸ“\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';

                // V2.3: Study Group buff (network >= 50 counts as +1 prep)
                const hasStudyGroup = (this.state.peerNetwork || 0) >= 50;
                const effectiveLevel = this.state.qualifyLevel + (hasStudyGroup ? 1 : 0);

                if (effectiveLevel >= 2) {
                    msg += 'âœ… QUALS PASSED! âœ…\n';
                    if (hasStudyGroup && this.state.qualifyLevel < 2) {
                        msg += 'Your study group helped you pass!';
                    } else {
                        msg += effectiveLevel >= 3 ? 'Your thorough preparation paid off!' : 'You passed the qualifying exam!';
                    }
                    this.state.morale = Math.min(100, this.state.morale + (effectiveLevel >= 3 ? 25 : 15));
                    this.state.qualsPassed = true;
                } else {
                    msg += 'âŒ QUALS FAILED âŒ\nYou needed at least 2 preparation sessions.';
                    this.endGame(false, 'quals_failed', 'You were dismissed after failing quals.');
                }

                this.showMessage(msg);
            },

            // End game
            endGame(won, reason, message) {
                this.state.isRunning = false;
                this.state.isEnded = true;
                this.state.endState = { won, reason, message };

                document.getElementById('game-screen').style.display = 'none';
                document.getElementById('end-screen').style.display = 'block';
                document.getElementById('end-screen').className = `end-screen panel ${won ? 'won' : 'lost'}`;

                // V2.2 Pro: Different messages for MS-Out vs PhD
                let title, endMessage;
                if (reason === 'ms_out') {
                    title = 'ğŸ“ Master\'s Degree Earned! ğŸ“';
                    endMessage = message;
                } else if (won) {
                    title = 'ğŸ“ğŸ‰ Congratulations, Doctor! ğŸ‰ğŸ“';
                    endMessage = 'You have defended your thesis and earned your PhD!';
                } else {
                    title = 'ğŸ’” Game Over ğŸ’”';
                    endMessage = message;
                }

                document.getElementById('end-title').textContent = title;
                document.getElementById('end-message').textContent = endMessage;
                document.getElementById('end-stats').innerHTML = `
                <p style="color: var(--text-secondary);">
                    Months elapsed: ${this.state.totalMonths}<br>
                    Papers published: ${this.getItem('paper')}<br>
                    Final morale: ${this.state.morale}%<br>
                    Peer Network: ${this.state.peerNetwork || 0}
                </p>
            `;
            },

            // Get available actions
            getActions() {
                const s = this.state;
                const actions = [];

                // Always available
                actions.push({ id: 'read', name: 'ğŸ“š Read Papers', desc: 'Search for ideas' });

                if (this.getItem('idea') > 0) {
                    actions.push({ id: 'work_idea', name: 'ğŸ’¡ Work on Idea', desc: 'Develop preliminary results' });
                }
                if (this.getItem('initial_findings') > 0) {
                    actions.push({ id: 'work_findings', name: 'ğŸ”¬ Develop Findings', desc: 'Work toward Key Discovery' });
                }
                if (this.getItem('key_discovery') > 0) {
                    const figures = this.getItem('figure') || 0;
                    if (this.hasStatus('brokenEquipment')) {
                        actions.push({ id: 'work_figures_blocked', name: 'ğŸ“Š Validate Discovery', desc: 'âš ï¸ BLOCKED - Equipment!', disabled: true });
                    } else {
                        actions.push({ id: 'work_figures', name: 'ğŸ“Š Validate Discovery', desc: `Figures: ${figures}/3` });
                    }
                }
                if (this.getItem('rejected_paper') > 0) {
                    actions.push({ id: 'revise', name: 'âœï¸ Revise Paper', desc: 'Revise and resubmit' });
                }
                // V2.5: Thesis requires 3 "journal equivalents" (2 conf papers = 1 journal)
                const journalPapers = this.getItem('paper') || 0;
                const confPapers = s.confPaperCount || 0;
                const journalEquivalent = journalPapers + Math.floor(confPapers / 2);
                if (journalEquivalent >= 3) {
                    actions.push({ id: 'thesis', name: 'ğŸ“ Work on Thesis', desc: `Defend! (${journalPapers}J + ${confPapers}C)` });
                }
                // V1.8: Show pending papers
                if (s.pendingPapers && s.pendingPapers.length > 0) {
                    actions.push({ id: 'pending', name: 'â³ Pending Papers', desc: s.pendingPapers.length + ' under review', disabled: true });
                }

                actions.push({ id: 'break', name: 'â˜• Take a Break', desc: 'Rest and recover' });

                // V2.5: Advisor-suggested vacation (fast recovery, optional)
                if (s.vacationOffered && !s.onVacation) {
                    actions.push({ id: 'vacation', name: 'ğŸ–ï¸ Take Time Off', desc: 'Advisor suggested rest' });
                }

                // V2.2 Pro: Pitch Session (always available after first year)
                if (!s.statuses.has('firstYear')) {
                    actions.push({ id: 'pitch', name: 'ğŸ’¬ Pitch Session', desc: 'Get advisor feedback on ideas' });
                }

                // V1.9: Conference limited - 1 first year, 3 after
                const maxConf = s.year === 1 ? 1 : 3;
                const confLeft = maxConf - (s.conferencesThisYear || 0);
                actions.push({
                    id: confLeft > 0 ? 'conference' : 'conference_disabled',
                    name: 'ğŸ¤ Conference',
                    desc: `(${confLeft}/${maxConf} remaining for this yr)`,
                    disabled: confLeft <= 0
                });

                // V2.2 Pro: Conference paper submission (if has figures but want quick publish)
                if (this.getItem('key_discovery') > 0 && this.getItem('figure') >= 3) {
                    actions.push({ id: 'conf_paper', name: 'ğŸ“‹ Conference Paper', desc: 'Quick publish (4mo, +network)' });
                    actions.push({ id: 'write_paper', name: 'ğŸ“ Journal Paper', desc: 'Submit for review (8-12mo)' });
                }

                // V2.2 Pro: Show pending conference papers
                if (s.pendingConference && s.pendingConference.length > 0) {
                    actions.push({ id: 'pending_conf', name: 'ğŸ“‹ Pending Conf', desc: s.pendingConference.length + ' under review', disabled: true });
                }

                // V2.3: Qual prep with urgency warnings and Study Group
                if ((s.year === 1) || (s.year === 2 && s.month < 9)) {
                    const monthsLeft = s.year === 1 ? (12 + 9 - s.month) : (9 - s.month);
                    const preps = s.qualifyLevel || 0;
                    const needed = 2 - preps;

                    // Study Group: High network counts as 1 prep
                    const hasStudyGroup = (s.peerNetwork || 0) >= 50;
                    const effectiveNeeded = hasStudyGroup && preps < 2 ? Math.max(0, needed - 1) : needed;

                    let qualsDesc = 'Study for exam';
                    let qualsName = 'ğŸ“– Prep for Quals';

                    // V2.3: Urgency warnings
                    if (s.year === 2 && monthsLeft <= 3 && effectiveNeeded > 0) {
                        qualsName = 'âš ï¸ğŸ“– URGENT: Quals Prep';
                        qualsDesc = `${monthsLeft}mo left! Need ${effectiveNeeded} more session${effectiveNeeded > 1 ? 's' : ''}`;
                    } else if (preps > 0) {
                        qualsDesc = `Progress: ${preps}/2 sessions`;
                    }
                    if (hasStudyGroup && preps < 2) {
                        qualsDesc += ' (+1 from Study Group)';
                    }

                    actions.push({ id: 'quals', name: qualsName, desc: qualsDesc });

                    // V2.3: Last-Minute Cram in August Y2
                    if (s.year === 2 && s.month === 8 && effectiveNeeded > 0) {
                        actions.push({
                            id: 'cram',
                            name: 'ğŸ†˜ Last-Minute Cram',
                            desc: 'Emergency! Pass quals but -25 morale'
                        });
                    }
                }

                // V2.2 Pro: MS-Out option (when offered)
                if (s.msOutOffered && s.morale < 30) {
                    actions.push({ id: 'ms_out', name: 'ğŸšª Master\'s Exit', desc: 'Leave with MS degree' });
                }

                actions.push({ id: 'advance', name: 'â© Next Month', desc: 'Skip to next month' });

                return actions;
            },

            // Perform action
            doAction(id) {
                if (this.state.isEnded) return;

                let msg = '';
                const s = this.state;

                switch (id) {
                    case 'read':
                        const readSuccess = [
                            'ğŸ’¡ A paper sparked a new research idea!',
                            'ğŸ’¡ Interesting! You see a gap in the literature...',
                            'ğŸ’¡ This could lead somewhere - new idea gained!'
                        ];
                        const readFail = [
                            'ğŸ“š You read papers but nothing clicked today.',
                            'ğŸ“š Dense reading. You learned, but no ideas yet.',
                            'ğŸ“š Most papers were tangential to your work.'
                        ];
                        if (this.random() < 0.4) {
                            this.addItem('idea');
                            msg = this.pick(readSuccess);
                        } else {
                            msg = this.pick(readFail);
                        }
                        if (this.random() < 0.05) {
                            this.addStatus('exhaustion');
                            msg += '\nğŸ˜« All that reading has left you exhausted...';
                        }
                        break;

                    case 'work_idea':
                        const ideaSuccess = [
                            'ğŸ‰ Initial Findings achieved! (+5 morale)',
                            'ğŸ‰ The experiment worked - Initial Findings! (+5 morale)',
                            'ğŸ‰ Promising results documented! (+5 morale)'
                        ];
                        // V2.5: Advisor feedback on ideas
                        const ideaFail = [
                            'ğŸ§‘â€ğŸ« Advisor: "This approach needs more thought..."',
                            'ğŸ§‘â€ğŸ« Advisor: "Inconclusive. Try a different angle."',
                            'ğŸ§‘â€ğŸ« Advisor: "Not quite what I had in mind..."'
                        ];
                        if (this.random() < 0.45) {
                            this.removeItem('idea');
                            this.addItem('initial_findings');
                            s.morale = Math.min(100, s.morale + 5);
                            msg = 'ğŸ§‘â€ğŸ« Advisor: "This is promising! Keep going." (+5 morale)\n' + this.pick(ideaSuccess);
                        } else {
                            msg = this.pick(ideaFail);
                        }
                        break;

                    case 'work_findings':
                        // V2.5: Advisor feedback on findings
                        const findSuccess = [
                            'ğŸ§‘â€ğŸ« Advisor: "Excellent work! This is publishable." (+5 morale)',
                            'ğŸ§‘â€ğŸ« Advisor: "Great results! Write this up." (+5 morale)',
                            'ğŸ§‘â€ğŸ« Advisor: "Solid discovery! I\'m impressed." (+5 morale)'
                        ];
                        const findFail = [
                            'ğŸ§‘â€ğŸ« Advisor: "The findings aren\'t strong enough yet..."',
                            'ğŸ§‘â€ğŸ« Advisor: "More controls needed. Redo the experiment."',
                            'ğŸ§‘â€ğŸ« Advisor: "Reviewers would tear this apart..."'
                        ];
                        if (this.random() < 0.35) {
                            this.removeItem('initial_findings');
                            this.addItem('key_discovery');
                            s.morale = Math.min(100, s.morale + 5);
                            msg = this.pick(findSuccess);
                        } else {
                            msg = this.pick(findFail);
                        }
                        break;

                    case 'work_figures':
                        if (this.random() < 0.6) {
                            this.addItem('figure');
                            s.morale = Math.min(100, s.morale + 3);
                            msg = 'ğŸ“Š Figure created! (' + this.getItem('figure') + '/3 needed) (+3 morale)';
                        } else {
                            const figFail = [
                                'ğŸ˜” The visualization isn\'t clear enough...',
                                'ğŸ˜” Reviewer 2 would hate this figure.',
                                'ğŸ˜” The data doesn\'t look right plotted this way.'
                            ];
                            msg = this.pick(figFail);
                        }
                        if (this.random() < 0.05) {
                            this.addStatus('brokenEquipment');
                            msg += '\nâš ï¸ Your equipment just broke down!';
                        }
                        break;

                    case 'write_paper':
                        this.removeItem('key_discovery');
                        // V2.1: Clear ALL figures (can't reuse for next paper)
                        delete this.state.items['figure'];
                        // V1.8: Paper goes to pending review
                        s.pendingPapers.push({ submitted: s.totalMonths, type: 'new' });
                        msg = 'ğŸ“® Paper submitted! Now we wait for the reviewers...';
                        break;

                    case 'revise':
                        this.removeItem('rejected_paper');
                        // V1.8: Revision goes to pending
                        s.pendingPapers.push({ submitted: s.totalMonths, type: 'revision' });
                        msg = 'ğŸ“® Revision submitted! Fingers crossed...';
                        break;

                    case 'break':
                        const gain = 5 + Math.floor(this.random() * 10);
                        s.morale = Math.min(100, s.morale + gain);
                        s.advisorScore = Math.max(0, s.advisorScore - 3);
                        msg = 'â˜• You took some time to recharge. (+' + gain + ' morale)';
                        if (this.hasStatus('exhaustion') && this.random() < 0.4) {
                            this.removeStatus('exhaustion');
                            msg += '\nğŸ’† You feel refreshed!';
                        }
                        if (this.hasStatus('unhappyAdvisor') && this.random() < 0.25) {
                            this.removeStatus('unhappyAdvisor');
                            msg += '\nğŸ¤ Your advisor has cooled down.';
                        }
                        break;

                    // V2.5: Advisor-suggested vacation (fast recovery)
                    case 'vacation':
                        const vacGain = 15 + Math.floor(this.random() * 11); // +15 to +25
                        s.morale = Math.min(s.maxMorale || 100, s.morale + vacGain);
                        s.vacationOffered = false; // Used up the offer
                        if (this.hasStatus('exhaustion')) this.removeStatus('exhaustion');
                        if (this.hasStatus('burnout')) this.removeStatus('burnout');
                        msg = 'ğŸ–ï¸ You took time off as your advisor suggested.\nYou feel refreshed! (+' + vacGain + ' morale, cleared exhaustion)';
                        break;

                    case 'conference':
                        s.conferencesThisYear = (s.conferencesThisYear || 0) + 1;
                        const confMorale = 2 + Math.floor(this.random() * 3); // 2-4
                        s.morale = Math.min(100, s.morale + confMorale);
                        msg = 'ğŸ¤ You attended a conference! (+' + confMorale + ' morale)';
                        if (this.random() < 0.35) {
                            this.addItem('idea');
                            msg += '\nğŸ’¡ The talks inspired a new idea!';
                        }
                        if (this.random() < 0.1) {
                            s.advisorScore = Math.min(100, s.advisorScore + 10);
                            msg += '\nğŸ¤ Your advisor heard good things!';
                        }
                        break;

                    case 'quals':
                        const points = Math.floor(this.random() * 3);
                        s.qualifyLevel += points;
                        if (points === 0) {
                            msg = 'ğŸ“– You studied but didn\'t retain much...';
                        } else if (points === 1) {
                            msg = 'ğŸ“– Decent study session!';
                        } else {
                            msg = 'ğŸ“– Great progress on exam prep!';
                        }
                        break;

                    // V2.4: Last-Minute Cram with Burnout Penalty
                    case 'cram':
                        s.qualifyLevel = Math.max(s.qualifyLevel, 2); // Guarantee pass
                        s.morale = Math.max(0, s.morale - 25);
                        // V2.4: Permanent penalty - reduce max morale
                        s.maxMorale = (s.maxMorale || 100) - 10;
                        this.addStatus('exhaustion');
                        this.addStatus('burnout'); // V2.4: New status
                        msg = 'ğŸ†˜ EMERGENCY CRAM SESSION!\nYou passed, but the toll on your mind is permanent. (-25 morale, max morale reduced)';
                        break;

                    case 'thesis':
                        document.getElementById('thesis-modal').classList.add('active');
                        return; // Don't advance month yet

                    case 'advance':
                        msg = 'Time passes...';
                        break;

                    // V2.2 Pro: Pitch Session
                    case 'pitch':
                        const adv = s.advisor;
                        const pitchMsgs = [];
                        if (adv.riskTolerance > 55) {
                            pitchMsgs.push('ğŸ’¬ "I like bold ideas - what\'s your craziest hypothesis?"');
                            s.strategicAlignment += 2;
                        } else if (adv.riskTolerance < 45) {
                            pitchMsgs.push('ğŸ’¬ "Let\'s stick to proven methods for now..."');
                        }
                        if (adv.strictness > 55) {
                            pitchMsgs.push('ğŸ’¬ "Every comma matters. Polish before showing me."');
                        } else if (adv.strictness < 45) {
                            pitchMsgs.push('ğŸ’¬ "Don\'t worry about perfection, show me progress!"');
                        }
                        if (adv.attentionSpan > 55) {
                            pitchMsgs.push('ğŸ’¬ "Send it over, I\'ll review tonight."');
                        } else if (adv.attentionSpan < 45) {
                            pitchMsgs.push('ğŸ’¬ "I\'ll get to it when I can... busy month."');
                        }
                        msg = pitchMsgs.length > 0 ? this.pick(pitchMsgs) : 'ğŸ’¬ Your advisor nods thoughtfully.';
                        s.peerNetwork = Math.min(100, s.peerNetwork + 3);
                        msg += '\n+3 peer network (learned advisor style)';
                        break;

                    // V2.2 Pro: Conference Paper (quick publish track)
                    case 'conf_paper':
                        this.removeItem('key_discovery');
                        delete this.state.items['figure'];
                        s.pendingConference.push({ submitted: s.totalMonths });
                        msg = 'ğŸ“‹ Conference paper submitted! (4 month review)';
                        break;

                    // V2.2 Pro: MS-Out (Master's exit)
                    case 'ms_out':
                        const profile = s.peerNetwork > 60 ? 'Industry R&D Lead' :
                            this.getItem('paper') >= 2 ? 'Data Scientist' : 'The Great Escape';
                        this.endGame(true, 'ms_out', 'You left with a Master\'s degree as: ' + profile);
                        return;
                }

                this.showMessage(msg);
                this.advanceMonth();
            },

            // Thesis actions
            thesisDefend() {
                document.getElementById('thesis-modal').classList.remove('active');
                if (this.random() < 0.9) {
                    this.showMessage('ğŸ“ğŸ‰ CONGRATULATIONS, DOCTOR! ğŸ‰ğŸ“\n\nYou\'ve successfully defended your thesis!');
                } else {
                    this.showMessage('ğŸ˜… The defense was rough, but you passed with major revisions!');
                }
                this.endGame(true, 'graduation', 'Congratulations, you have earned your PhD!');
            },

            // V1.7: Help modal
            showHelp() {
                document.getElementById('help-modal').classList.add('active');
            },

            hideHelp() {
                document.getElementById('help-modal').classList.remove('active');
            },

            // V2.0.1: Show seed info
            showSeed() {
                const seed = this.state.seed || 'random';
                const url = window.location.origin + window.location.pathname + '?seed=' + seed;
                alert('Current Seed: ' + seed + '\n\nShare this URL:\n' + url);
            },

            thesisStay() {
                document.getElementById('thesis-modal').classList.remove('active');
                this.state.morale = Math.min(100, this.state.morale + 20);
                this.state.advisorScore = Math.min(100, this.state.advisorScore + 10);
                this.showMessage('You decide to stay and do more research. Your advisor is pleased. (+20 morale)');
                this.advanceMonth();
            },

            // Update UI
            updateUI() {
                const s = this.state;

                // Stats
                document.getElementById('date').textContent = `${this.months[s.month]}, Year ${s.year}`;
                document.getElementById('total-months').textContent = s.totalMonths;
                document.getElementById('papers').textContent = this.getItem('paper');
                // V2.2 Pro: Peer Network
                document.getElementById('peer-network').textContent = s.peerNetwork || 10;

                // V2.0.1: Morale as descriptive text
                const moraleBar = document.getElementById('morale-bar');
                moraleBar.style.width = `${s.morale}%`;
                let moraleText, moraleClass;
                if (s.morale > 75) { moraleText = 'ğŸ˜„ Great'; moraleClass = 'high'; }
                else if (s.morale > 50) { moraleText = 'ğŸ˜Š Good'; moraleClass = 'high'; }
                else if (s.morale > 30) { moraleText = 'ğŸ˜ Okay'; moraleClass = 'medium'; }
                else if (s.morale > 15) { moraleText = 'ğŸ˜Ÿ Low'; moraleClass = 'low'; }
                else { moraleText = 'ğŸ˜° Critical'; moraleClass = 'low'; }
                document.getElementById('morale-status').textContent = moraleText;
                moraleBar.className = 'progress-fill ' + moraleClass;

                // Advisor
                const advisorBar = document.getElementById('advisor-bar');
                advisorBar.style.width = `${s.advisorScore}%`;
                const hasUnhappy = this.hasStatus('unhappyAdvisor');
                if (hasUnhappy || s.advisorScore < 30) {
                    document.getElementById('advisor-status').textContent = 'ğŸ˜  Unhappy';
                    advisorBar.className = 'progress-fill low';
                } else if (s.advisorScore < 50) {
                    document.getElementById('advisor-status').textContent = 'ğŸ˜ Neutral';
                    advisorBar.className = 'progress-fill medium';
                } else {
                    document.getElementById('advisor-status').textContent = 'ğŸ™‚ Happy';
                    advisorBar.className = 'progress-fill high';
                }

                // Actions
                const actionsEl = document.getElementById('actions');
                actionsEl.innerHTML = this.getActions().map(a => `
                <button class="action-btn${a.disabled ? ' disabled' : ''}" ${a.disabled ? '' : `onclick="game.doAction('${a.id}')"`}>
                    <div class="action-name">${a.name}</div>
                    <div class="action-desc">${a.desc}</div>
                </button>
            `).join('');

                // V2.0: Pipeline Visualizer
                const pipelineEl = document.getElementById('pipeline');
                const stages = [
                    { icon: 'ğŸ“š', label: 'Ideas', count: this.getItem('idea') },
                    { icon: 'â†’', label: '' },
                    { icon: 'ğŸ”¬', label: 'Findings', count: this.getItem('initial_findings') },
                    { icon: 'â†’', label: '' },
                    { icon: 'ğŸ¯', label: 'Discovery', count: this.getItem('key_discovery') },
                    { icon: 'â†’', label: '' },
                    { icon: 'ğŸ“Š', label: 'Figures', count: this.getItem('figure') },
                    { icon: 'â†’', label: '' },
                    { icon: 'ğŸ“', label: 'Papers', count: this.getItem('paper') }
                ];

                pipelineEl.innerHTML = stages.map(st => {
                    if (st.label === '') return `<span style="color: var(--text-secondary);">${st.icon}</span>`;
                    const hasItems = st.count > 0;
                    const style = hasItems
                        ? 'background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 4px 10px; border-radius: 12px;'
                        : 'color: var(--text-secondary);';
                    return `<span style="${style}">${st.icon} ${st.label}${hasItems ? ' Ã—' + st.count : ''}</span>`;
                }).join('');

                // Pending/Rejected/TA/Conference Papers
                const extras = [];
                const confPapers = s.confPaperCount || 0;
                if (confPapers > 0) extras.push('ğŸ“‹ Conf Papers Ã—' + confPapers);
                if (this.getItem('rejected_paper') > 0) extras.push('âŒ Rejected Ã—' + this.getItem('rejected_paper'));
                if (s.pendingPapers && s.pendingPapers.length > 0) extras.push('â³ Under Review Ã—' + s.pendingPapers.length);
                if (s.isTeaching) extras.push('ğŸ“ TA Duty (' + s.teachingMonths + ' mo)');
                if (extras.length > 0) {
                    pipelineEl.innerHTML += '<br><span style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">' + extras.join(' | ') + '</span>';
                }

                // Statuses
                const statusesEl = document.getElementById('statuses');
                const statusNames = { exhaustion: 'Exhaustion', unhappyAdvisor: 'Unhappy Advisor', brokenEquipment: 'Broken Equipment', firstYear: 'First Year' };
                const negatives = ['exhaustion', 'unhappyAdvisor', 'brokenEquipment'];
                if (s.statuses.size > 0) {
                    statusesEl.innerHTML = Array.from(s.statuses).map(id =>
                        `<span class="status-badge${negatives.includes(id) ? ' negative' : ''}">${statusNames[id] || id}</span>`
                    ).join('');
                } else {
                    statusesEl.innerHTML = '<span class="empty-text">No effects</span>';
                }
            }
        };

        // Check for saved game on load
        document.addEventListener('DOMContentLoaded', () => game.checkSave());
    </script>

    <!-- GoatCounter Analytics -->
    <script data-goatcounter="https://wangxiangyu.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>